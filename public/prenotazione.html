<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Clienti – Ecodrin</title>
  <style>
    body { font-family: Arial; background: #f4f6f8; margin: 0; }
    main {
      max-width: 800px; margin: 30px auto;
      background: white; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h2, h3 { margin-top: 0; }
    input, select, textarea {
      width: 100%; padding: 10px; margin-bottom: 15px;
      border: 1px solid #ccc; border-radius: 4px; font-size: 16px;
    }
    button {
      padding: 10px 15px; border: none;
      background: #007acc; color: white;
      border-radius: 4px; cursor: pointer; font-size: 16px;
    }
    .hidden { display: none; }
    .top-nav {
      display: flex; justify-content: space-between;
      align-items: center; flex-wrap: wrap; gap: 10px;
      margin-bottom: 20px;
    }
    .chat-box {
      border: 1px solid #ccc; padding: 10px;
      border-radius: 6px; max-height: 300px;
      overflow-y: auto; background: #f9f9f9;
      margin-bottom: 10px;
    }
    .msg {
      background: #fff; padding: 8px; margin-bottom: 6px;
      border-left: 4px solid #007acc; border-radius: 4px;
    }
    .msg small {
      font-size: 11px; color: #555; display: block;
    }

    @media (max-width: 600px) {
      body { padding: 10px; }
      main { padding: 20px; margin: 10px; }
      input, select, button { font-size: 16px; }
    }
  </style>
</head>
<body>

<main>
  <!-- Login -->
  <div id="authBox">
    <h2>Accesso Clienti</h2>
    <input id="loginEmail" placeholder="Ragione Sociale">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p><a href="#" onclick="toggleRegistro()">Non hai un account? Registrati</a></p>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <!-- Registrazione -->
  <div id="regBox" class="hidden">
    <h2>Registrazione</h2>
    <input id="regRagione" placeholder="Ragione Sociale">
    <input id="regCF" placeholder="Codice Fiscale">
    <input id="regPassword" type="password" placeholder="Password">
    <button onclick="registrati()">Registrati</button>
    <p><a href="#" onclick="toggleRegistro()">Hai già un account? Login</a></p>
    <div id="regErrore" style="color:red;"></div>
  </div>

  <!-- Area cliente -->
  <div id="clienteBox" class="hidden">
    <div class="top-nav">
      <div>Benvenuto, <span id="nomeCliente"></span></div>
      <select onchange="switchClientePage(this.value)">
        <option value="prenota">📦 Prenota</option>
        <option value="elenco">📋 Le tue prenotazioni</option>
        <option value="logout">🚪 Logout</option>
      </select>
    </div>

    <!-- Form prenotazione -->
    <div id="paginaPrenota">
      <h3>📦 Prenotazione Rifiuti</h3>
      <form id="formPrenotazione">
        <input name="produttore" placeholder="Produttore" required>
        <input name="codiceCER" placeholder="Codice CER" required>
        <input name="quantita" type="number" placeholder="Quantità (kg)" required>

        <!-- Pericolosità -->
        <select name="pericolosita" required>
          <option value="">Classe di pericolosità</option>
          <option value="HP1">HP1 – Esplosivo</option>
          <option value="HP2">HP2 – Comburente</option>
          <option value="HP3">HP3 – Infiammabile</option>
          <option value="HP4">HP4 – Irritante</option>
          <option value="HP5">HP5 – Tossicità organi bersaglio</option>
          <option value="HP6">HP6 – Tossico acuto</option>
          <option value="HP7">HP7 – Cancerogeno</option>
          <option value="HP8">HP8 – Corrosivo</option>
          <option value="HP9">HP9 – Infettivo</option>
          <option value="HP10">HP10 – Tossico riproduzione</option>
          <option value="HP11">HP11 – Mutageno</option>
          <option value="HP12">HP12 – Rilascia gas tossici</option>
          <option value="HP13">HP13 – Sensibilizzante</option>
          <option value="HP14">HP14 – Ecotossico</option>
          <option value="HP15">HP15 – Rischio secondario</option>
        </select>

        <!-- Stato Fisico -->
        <select name="statoFisico" required>
          <option value="">Stato fisico</option>
          <option value="1 - Solido pulverulento">1 - Solido pulverulento</option>
          <option value="2 - Solido non pulverulento">2 - Solido non pulverulento</option>
          <option value="3 - Fangoso palabile">3 - Fangoso palabile</option>
          <option value="4 - Fangoso non palabile">4 - Fangoso non palabile</option>
          <option value="5 - Liquido">5 - Liquido</option>
          <option value="6 - Liquido denso">6 - Liquido denso</option>
          <option value="7 - Fangoso liquido">7 - Fangoso liquido</option>
          <option value="8 - Gas compressi">8 - Gas compressi</option>
          <option value="9 - Gas liquefatti">9 - Gas liquefatti</option>
          <option value="10 - Altro">10 - Altro</option>
        </select>

        <input name="tipoImballo" placeholder="Tipo Imballo">
        <input name="data" type="date" required>
        <input name="analisi" type="file" />
        <button type="submit">Invia Prenotazione</button>
      </form>
    </div>

    <!-- Elenco prenotazioni -->
    <div id="paginaElenco" class="hidden">
      <h3>📋 Le Tue Prenotazioni</h3>
      <div id="prenotazioni"></div>
    </div>
  </div>
</main>
<script>
let cliente = null;
const chatTimers = {};
const chatLastMessage = {};

if ("Notification" in window) {
  Notification.requestPermission();
}

function toggleRegistro() {
  document.getElementById('authBox').classList.toggle('hidden');
  document.getElementById('regBox').classList.toggle('hidden');
  document.getElementById('loginErrore').innerText = '';
  document.getElementById('regErrore').innerText = '';
}

function login() {
  const ragioneSociale = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === 'cliente') {
      cliente = json.utente;
      document.getElementById('nomeCliente').innerText = cliente.ragioneSociale;
      document.getElementById('authBox').classList.add('hidden');
      document.getElementById('clienteBox').classList.remove('hidden');
      caricaPrenotazioni();
    } else {
      throw new Error();
    }
  })
  .catch(() => {
    document.getElementById('loginErrore').innerText = '❌ Credenziali errate';
  });
}

document.getElementById('loginPassword').addEventListener('keydown', e => {
  if (e.key === 'Enter') login();
});

function registrati() {
  const ragioneSociale = document.getElementById('regRagione').value.trim();
  const codiceFiscale = document.getElementById('regCF').value.trim();
  const password = document.getElementById('regPassword').value.trim();

  fetch('/api/registrazione', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale, codiceFiscale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(() => {
    alert('Registrazione completata!');
    toggleRegistro();
  })
  .catch(() => {
    document.getElementById('regErrore').innerText = '⚠️ Errore nella registrazione';
  });
}

document.getElementById('formPrenotazione').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const dati = new FormData(form);
  dati.append('email', cliente.email);
  dati.append('codiceCliente', cliente.codiceCliente);
  dati.append('ragioneSociale', cliente.ragioneSociale);

  fetch('/api/prenotazioni', {
    method: 'POST',
    body: dati
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(() => {
    alert('Prenotazione inviata');
    form.reset();
    caricaPrenotazioni();
    switchClientePage('elenco');
  })
  .catch(() => alert('Errore nella prenotazione'));
});

async function caricaPrenotazioni() {
  const res = await fetch(`/api/prenotazioni/utente/${cliente.codiceCliente}`);
  const lista = await res.json();
  const div = document.getElementById('prenotazioni');
  div.innerHTML = '';

  if (!lista.length) {
    div.innerHTML = '<p style="color:gray;">Nessuna prenotazione inviata.</p>';
    return;
  }

  lista.sort((a,b) => new Date(b.data) - new Date(a.data));

  for (const p of lista) {
    const box = document.createElement('div');
    box.style.border = '1px solid #ccc';
    box.style.padding = '10px';
    box.style.margin = '10px 0';
    box.style.borderRadius = '6px';

    box.innerHTML = `
      <b>Data:</b> ${p.data}<br>
      <b>CER:</b> ${p.codiceCER} – <b>Quantità:</b> ${p.quantita} kg<br>
      <b>Pericolosità:</b> ${p.pericolosita || 'N/D'}<br>
      <b>Stato Fisico:</b> ${p.statoFisico || 'N/D'}<br>
      <b>Tipo Imballo:</b> ${p.tipoImballo || 'N/D'}<br>
      <b>Stato:</b> ${p.stato}<br>
      ${p.analisi ? `<b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">📎 Visualizza</a><br>` : ''}
      <div class="chat-box" id="chat-${p.id}">Caricamento messaggi...</div>
      <input id="msg-${p.id}" placeholder="Scrivi un messaggio..." />
      <button onclick="inviaMessaggio(${p.id})">📨</button>
    `;

    div.appendChild(box);
    caricaChat(p.id);

    setTimeout(() => {
      const input = document.getElementById(`msg-${p.id}`);
      input?.addEventListener('keydown', e => {
        if (e.key === 'Enter') inviaMessaggio(p.id);
      });
    }, 100);
  }
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chat-${id}`);
  if (!box) return;

  // 🔔 Notifica nuovi messaggi
  const lastMsg = chat[chat.length - 1];
  const lastKnown = chatLastMessage[id]?.timestamp;
  if (
    lastMsg &&
    (!lastKnown || lastMsg.timestamp > lastKnown) &&
    lastMsg.autore !== cliente.ragioneSociale
  ) {
    if (Notification.permission === "granted") {
      new Notification("📨 Nuovo messaggio da " + lastMsg.autore, {
        body: lastMsg.testo,
      });
    }
    try {
      new Audio("/sounds/notify.mp3").play();
    } catch (e) {}
  }
  chatLastMessage[id] = lastMsg;

  box.innerHTML = chat.map(m => `
    <div class="msg">
      <b>${m.autore}</b>: ${m.testo}<br>
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>`).join('');
  box.scrollTop = box.scrollHeight;

  if (!chatTimers[id]) {
    chatTimers[id] = setInterval(() => caricaChat(id), 2000);
  }
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`msg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: cliente.ragioneSociale, testo })
  });
  input.value = '';
  caricaChat(id);
}

function switchClientePage(p) {
  if (p === 'logout') return location.reload();
  document.getElementById('paginaPrenota').classList.add('hidden');
  document.getElementById('paginaElenco').classList.add('hidden');
  if (p === 'prenota') document.getElementById('paginaPrenota').classList.remove('hidden');
  if (p === 'elenco') document.getElementById('paginaElenco').classList.remove('hidden');
}
</script>
</body>
</html>
