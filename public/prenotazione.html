    <!-- FORM PRENOTAZIONE -->
    <section id="formPrenotazione" class="section">
      <h2>â• Nuova Prenotazione</h2>
      <form id="form">
        <label>Produttore</label>
        <input name="produttore" required />
        <label>Codice CER</label>
        <input name="codiceCER" required />
        <label>PericolositÃ  (HP)</label>
        <select name="pericolosita" multiple>
          <option>HP1</option><option>HP2</option><option>HP3</option><option>HP4</option><option>HP5</option>
          <option>HP6</option><option>HP7</option><option>HP8</option><option>HP9</option><option>HP10</option>
          <option>HP11</option><option>HP12</option><option>HP13</option><option>HP14</option><option>HP15</option>
        </select>
        <label>Tipo Imballo</label>
        <select name="tipoImballo" required>
          <option>sfuso</option><option>big bags</option><option>pallet</option>
          <option>cisterna 5mc</option><option>cisterna 15mc</option>
          <option>cisterna 30mc</option><option>altro</option>
        </select>
        <label>Stato Fisico</label>
        <select name="statoFisico" required>
          <option>SP (polverulento)</option><option>S (solido)</option>
          <option>VS (vischioso/sciropposo)</option><option>Fp (fangoso)</option><option>L (liquido)</option>
        </select>
        <label>QuantitÃ  (kg)</label>
        <input name="quantita" type="number" required />
        <label>Data Ritiro</label>
        <input name="data" type="date" required />
        <label>Allega Analisi (PDF)</label>
        <input name="analisi" type="file" accept=".pdf" />
        <button type="submit">ğŸ“¨ Invia Prenotazione</button>
        <div id="msgRisultato" style="margin-top: 10px;"></div>
      </form>
    </section>

    <!-- FORM RICHIESTA TRASPORTO -->
    <section id="formTrasporto" class="section hidden">
      <h2>ğŸš› Richiesta Trasporto</h2>
      <form id="formTrasportoForm">
        <label>Richiedente</label>
        <input name="richiedente" id="richiedente" />
        <label>Produttore</label>
        <input name="produttore" required />
        <label>Codice CER</label>
        <input name="codiceCER" required />
        <label>Tipo Automezzo</label>
        <select name="automezzo" required>
          <option>Motrice</option>
          <option>Autotreno</option>
          <option>Cassonato</option>
          <option>Ribaltabile</option>
          <option>Altro</option>
        </select>
        <label>Data Trasporto</label>
        <input name="dataTrasporto" type="date" required />
        <label>Fascia Oraria Preferita</label>
        <select name="fasciaOraria" required>
          <option>8:30â€“10:30</option>
          <option>10:30â€“12:30</option>
          <option>14:30â€“16:30</option>
        </select>
        <label>Referente e Cellulare</label>
        <input name="referente" placeholder="Nome referente" required />
        <input name="cellulare" type="tel" placeholder="Cellulare" required />
        <label>Prezzo pattuito (â‚¬)</label>
        <input name="prezzo" type="number" step="0.01" required />
        <button type="submit">ğŸ“¨ Invia Richiesta</button>
        <div id="msgTrasporto" style="margin-top:10px;"></div>
      </form>
    </section>

    <!-- ARCHIVIO PRENOTAZIONI -->
    <section id="archivioPrenotazioni" class="section hidden">
      <h2>ğŸ“ Le Tue Prenotazioni</h2>
      <div id="contenitorePrenotazioni"></div>
    </section>

    <!-- ARCHIVIO TRASPORTI -->
    <section id="archivioTrasporti" class="section hidden">
      <h2>ğŸ“¦ Le Tue Richieste di Trasporto</h2>
      <div id="contenitoreTrasporti"></div>
    </section>

    <!-- PROFILO -->
    <section id="profiloCliente" class="section hidden">
      <h2>ğŸ‘¤ Profilo Cliente</h2>
      <form id="formProfilo">
        <label>Ragione Sociale (non modificabile)</label>
        <input name="ragioneSociale" id="profiloRagione" disabled />
        <label>Email</label>
        <input name="email" type="email" required />
        <label>Telefono</label>
        <input name="telefono" type="text" />
        <label>Nuova Password</label>
        <input name="nuovaPassword" type="password" />
        <label>Autorizzazioni (PDF)</label>
        <input name="autorizzazioni" type="file" accept=".pdf" />
        <button type="submit">ğŸ’¾ Salva Profilo</button>
        <div id="profiloMsg" style="margin-top: 10px;"></div>
      </form>
    </section>
  </div>
</main>

<footer>
  ğŸ“ Via delle Industrie â€“ Zona Asi - 80011 Acerra (NA)<br />
  ğŸ“ 081.8857480 / 081.5207650<br />
  âœ‰ï¸ info@ecodrinsrl.it / impianto@ecodrinsrl.it<br />
  Â©2025 Eco.Drin s.r.l. â€“ P.I: 03378791218
</footer>

<!-- SCRIPT JS -->
<script src="cliente-script.js"></script>
</body>
</html>

  
 <!-- parte 2 -->
    <!-- FORM PRENOTAZIONE -->
    <section id="formPrenotazione" class="section">
      <h2>â• Nuova Prenotazione</h2>
      <form id="form">
        <label>Produttore</label>
        <input name="produttore" required />
        <label>Codice CER</label>
        <input name="codiceCER" required />
        <label>PericolositÃ  (HP)</label>
        <select name="pericolosita" multiple>
          <option>HP1</option><option>HP2</option><option>HP3</option><option>HP4</option><option>HP5</option>
          <option>HP6</option><option>HP7</option><option>HP8</option><option>HP9</option><option>HP10</option>
          <option>HP11</option><option>HP12</option><option>HP13</option><option>HP14</option><option>HP15</option>
        </select>
        <label>Tipo Imballo</label>
        <select name="tipoImballo" required>
          <option>sfuso</option><option>big bags</option><option>pallet</option>
          <option>cisterna 5mc</option><option>cisterna 15mc</option>
          <option>cisterna 30mc</option><option>altro</option>
        </select>
        <label>Stato Fisico</label>
        <select name="statoFisico" required>
          <option>SP (polverulento)</option><option>S (solido)</option>
          <option>VS (vischioso/sciropposo)</option><option>Fp (fangoso)</option><option>L (liquido)</option>
        </select>
        <label>QuantitÃ  (kg)</label>
        <input name="quantita" type="number" required />
        <label>Data Ritiro</label>
        <input name="data" type="date" required />
        <label>Allega Analisi (PDF)</label>
        <input name="analisi" type="file" accept=".pdf" />
        <button type="submit">ğŸ“¨ Invia Prenotazione</button>
        <div id="msgRisultato" style="margin-top: 10px;"></div>
      </form>
    </section>

    <!-- FORM RICHIESTA TRASPORTO -->
    <section id="formTrasporto" class="section hidden">
      <h2>ğŸš› Richiesta Trasporto</h2>
      <form id="formTrasportoForm">
        <label>Richiedente</label>
        <input name="richiedente" id="richiedente" />
        <label>Produttore</label>
        <input name="produttore" required />
        <label>Codice CER</label>
        <input name="codiceCER" required />
        <label>Tipo Automezzo</label>
        <select name="automezzo" required>
          <option>Motrice</option>
          <option>Autotreno</option>
          <option>Cassonato</option>
          <option>Ribaltabile</option>
          <option>Altro</option>
        </select>
        <label>Data Trasporto</label>
        <input name="dataTrasporto" type="date" required />
        <label>Fascia Oraria Preferita</label>
        <select name="fasciaOraria" required>
          <option>8:30â€“10:30</option>
          <option>10:30â€“12:30</option>
          <option>14:30â€“16:30</option>
        </select>
        <label>Referente e Cellulare</label>
        <input name="referente" placeholder="Nome referente" required />
        <input name="cellulare" type="tel" placeholder="Cellulare" required />
        <label>Prezzo pattuito (â‚¬)</label>
        <input name="prezzo" type="number" step="0.01" required />
        <button type="submit">ğŸ“¨ Invia Richiesta</button>
        <div id="msgTrasporto" style="margin-top:10px;"></div>
      </form>
    </section>

    <!-- ARCHIVIO PRENOTAZIONI -->
    <section id="archivioPrenotazioni" class="section hidden">
      <h2>ğŸ“ Le Tue Prenotazioni</h2>
      <div id="contenitorePrenotazioni"></div>
    </section>

    <!-- ARCHIVIO TRASPORTI -->
    <section id="archivioTrasporti" class="section hidden">
      <h2>ğŸ“¦ Le Tue Richieste di Trasporto</h2>
      <div id="contenitoreTrasporti"></div>
    </section>

    <!-- PROFILO -->
    <section id="profiloCliente" class="section hidden">
      <h2>ğŸ‘¤ Profilo Cliente</h2>
      <form id="formProfilo">
        <label>Ragione Sociale (non modificabile)</label>
        <input name="ragioneSociale" id="profiloRagione" disabled />
        <label>Email</label>
        <input name="email" type="email" required />
        <label>Telefono</label>
        <input name="telefono" type="text" />
        <label>Nuova Password</label>
        <input name="nuovaPassword" type="password" />
        <label>Autorizzazioni (PDF)</label>
        <input name="autorizzazioni" type="file" accept=".pdf" />
        <button type="submit">ğŸ’¾ Salva Profilo</button>
        <div id="profiloMsg" style="margin-top: 10px;"></div>
      </form>
    </section>
  </div>
</main>

<footer>
  ğŸ“ Via delle Industrie â€“ Zona Asi - 80011 Acerra (NA)<br />
  ğŸ“ 081.8857480 / 081.5207650<br />
  âœ‰ï¸ info@ecodrinsrl.it / impianto@ecodrinsrl.it<br />
  Â©2025 Eco.Drin s.r.l. â€“ P.I: 03378791218
</footer>

<!-- SCRIPT JS -->
<script src="cliente-script.js"></script>
</body>
</html>
<!-- parte 3 -->
<script>
let utente = null;
const chatTimers = {};
const chatLastMessage = {};

if ("Notification" in window) Notification.requestPermission();

function mostraSezione(id) {
  [
    "formPrenotazione", "archivioPrenotazioni", "formTrasporto",
    "archivioTrasporti", "profiloCliente"
  ].forEach(s => {
    document.getElementById(s).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");
}

function logout() {
  utente = null;
  document.getElementById("contenutoCliente").classList.add("hidden");
  document.getElementById("logoutBtn").classList.add("hidden");
  document.getElementById("loginBox").classList.remove("hidden");
}

function login() {
  const ragioneSociale = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ragioneSociale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === "cliente") {
      utente = json.utente;
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("contenutoCliente").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      document.getElementById("richiedente").value = utente.ragioneSociale;
      document.getElementById("profiloRagione").value = utente.ragioneSociale;
      document.querySelector("[name='email']").value = utente.email;
      caricaPrenotazioni();
      caricaTrasporti();
    } else throw new Error();
  })
  .catch(() => document.getElementById("loginErrore").innerText = "âŒ Login fallito.");
}

document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append("ragioneSociale", utente.ragioneSociale);
  formData.append("codiceCliente", utente.codiceCliente);
  formData.append("email", utente.email);
  const hp = Array.from(e.target.elements["pericolosita"].selectedOptions).map(o => o.value);
  formData.set("pericolosita", hp.join(", "));

  document.getElementById("msgRisultato").textContent = "â³ Invio...";
  try {
    const res = await fetch("/api/prenotazioni", { method: "POST", body: formData });
    if (!res.ok) throw new Error();
    e.target.reset();
    document.getElementById("msgRisultato").textContent = "âœ… Prenotazione inviata!";
    caricaPrenotazioni();
    mostraSezione("archivioPrenotazioni");
  } catch {
    document.getElementById("msgRisultato").textContent = "âŒ Errore durante l'invio.";
  }
});

document.getElementById("formTrasportoForm").addEventListener("submit", async e => {
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append("codiceCliente", utente.codiceCliente);
  formData.append("email", utente.email);

  document.getElementById("msgTrasporto").textContent = "â³ Invio...";
  try {
    const res = await fetch("/api/trasporti", { method: "POST", body: formData });
    if (!res.ok) throw new Error();
    e.target.reset();
    document.getElementById("msgTrasporto").textContent = "âœ… Richiesta inviata!";
    caricaTrasporti();
    mostraSezione("archivioTrasporti");
  } catch {
    document.getElementById("msgTrasporto").textContent = "âŒ Errore durante l'invio.";
  }
});

document.getElementById("formProfilo").addEventListener("submit", async e => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);
  formData.append("codiceCliente", utente.codiceCliente);

  try {
    const res = await fetch("/api/cliente/profilo", {
      method: "POST", body: formData
    });
    if (!res.ok) throw new Error();
    document.getElementById("profiloMsg").textContent = "âœ… Profilo aggiornato!";
  } catch {
    document.getElementById("profiloMsg").textContent = "âŒ Errore salvataggio profilo.";
  }
});

async function caricaPrenotazioni() {
  const res = await fetch(`/api/prenotazioni/utente/${utente.codiceCliente}`);
  const dati = await res.json();
  const contenitore = document.getElementById("contenitorePrenotazioni");
  contenitore.innerHTML = "";

  const gruppi = {};
  dati.forEach(p => {
    if (!gruppi[p.data]) gruppi[p.data] = [];
    gruppi[p.data].push(p);
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const wrapper = document.createElement("div");
    const toggle = document.createElement("div");
    toggle.className = "giorno-blocco";
    toggle.textContent = `ğŸ“… ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => {
      const box = wrapper.querySelector(".prenotazioni-giorno");
      box.classList.toggle("hidden");
    };
    const contenuto = document.createElement("div");
    contenuto.className = "prenotazioni-giorno hidden";

    gruppi[data].forEach(p => {
      const div = document.createElement("div");
      div.className = "prenotazione";
      div.innerHTML = `
        <b>CER:</b> ${p.codiceCER} | <b>QuantitÃ :</b> ${p.quantita} kg<br>
        <b>PericolositÃ :</b> ${p.pericolosita || "N/D"} | <b>Stato:</b> ${p.stato}<br>
        <b>Data:</b> ${formattaData(p.data)}<br>
        ${p.analisi ? `<b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">ğŸ“ Visualizza</a><br>` : ""}
        <b>Chat:</b>
        <div class="chat-messaggi" id="chatMsg-${p.id}">Caricamento...</div>
        <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMessaggio(${p.id})" />
        <button onclick="inviaMessaggio(${p.id})">ğŸ“¨ Invia</button>
      `;
      contenuto.appendChild(div);
      caricaChat(p.id, "prenotazioni");
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    contenitore.appendChild(wrapper);
  });
}

async function caricaTrasporti() {
  const res = await fetch(`/api/trasporti/utente/${utente.codiceCliente}`);
  const dati = await res.json();
  const contenitore = document.getElementById("contenitoreTrasporti");
  contenitore.innerHTML = "";

  dati.forEach(p => {
    const div = document.createElement("div");
    div.className = "prenotazione";
    div.innerHTML = `
      <b>Data:</b> ${formattaData(p.dataTrasporto)} | <b>Stato:</b> ${p.stato || "In attesa"}<br>
      <b>Produttore:</b> ${p.produttore}<br>
      <b>Automezzo:</b> ${p.automezzo} | <b>Fascia:</b> ${p.fasciaOraria}<br>
      <b>Referente:</b> ${p.referente} - ${p.cellulare}<br>
      <b>Prezzo:</b> â‚¬ ${p.prezzo}<br>
      <div class="chat-messaggi" id="chatTrasporto-${p.id}">Caricamento...</div>
      <input id="inputTrasporto-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMessaggio(${p.id}, 'trasporti')" />
      <button onclick="inviaMessaggio(${p.id}, 'trasporti')">ğŸ“¨ Invia</button>
    `;
    contenitore.appendChild(div);
    caricaChat(p.id, "trasporti");
  });
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

async function caricaChat(id, tipo = "prenotazioni") {
  const res = await fetch(`/api/${tipo}/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chat${tipo === "trasporti" ? "Trasporto" : "Msg"}-${id}`);
  if (!box) return;

  const lastMsg = chat[chat.length - 1];
  const lastKnown = chatLastMessage[id]?.timestamp;

  if (
    lastMsg &&
    (!lastKnown || lastMsg.timestamp > lastKnown) &&
    lastMsg.autore !== utente.ragioneSociale
  ) {
    try { new Audio("/sounds/notify.mp3").play(); } catch (e) {}
  }

  chatLastMessage[id] = lastMsg;

  box.innerHTML = chat.map(m => `
    <div class="msg">
      <b>${m.autore}</b>: ${m.testo}
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;

  if (!chatTimers[id]) {
    chatTimers[id] = setInterval(() => caricaChat(id, tipo), 2000);
  }
}

async function inviaMessaggio(id, tipo = "prenotazioni") {
  const inputId = tipo === "trasporti" ? `inputTrasporto-${id}` : `inputMsg-${id}`;
  const input = document.getElementById(inputId);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`/api/${tipo}/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: utente.ragioneSociale, testo })
  });

  input.value = "";
  caricaChat(id, tipo);
}
</script>



