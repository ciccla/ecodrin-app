<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Area Clienti ‚Äì Eco.Drin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f1f4f6;
      color: #333;
    }

    header {
      background-color: #004c45;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    header img {
      height: 50px;
    }

    main {
      max-width: 1000px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    h2 {
      color: #004c45;
    }

    .hidden {
      display: none;
    }

    .section {
      margin-bottom: 40px;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: 600;
    }

    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }

    button {
      margin-top: 20px;
      background-color: #00785c;
      color: white;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background-color: #009072;
    }

    .giorno-blocco {
      background: #eafaf5;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      border: 1px solid #b3e5c5;
    }

    .prenotazione {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }

    .chat-messaggi {
      background: #f8f9fa;
      padding: 10px;
      border: 1px solid #ccc;
      max-height: 150px;
      overflow-y: auto;
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .msg {
      background: #e1f5ec;
      margin-bottom: 5px;
      padding: 8px 10px;
      border-radius: 6px;
    }

    .msg small {
      display: block;
      font-size: 11px;
      color: #555;
    }

    footer {
      text-align: center;
      font-size: 14px;
      padding: 20px;
      color: #777;
      margin-top: 40px;
    }
  </style>
</head>
/* ... altri stili ... */

  .chat-notifica {
    display: inline-block;
    background: #dc3545;
    color: white;
    font-size: 12px;
    padding: 2px 8px;
    border-radius: 12px;
    margin-left: 8px;
    vertical-align: middle;
  }

  .hidden {
    display: none !important;
  }
</style>
<body>

<header>
  <div style="display:flex; align-items:center; gap:15px;">
    <a href="index.html"><img src="eco.drin-_srl.png" alt="Logo Ecodrin" /></a>
    <h1 style="margin:0;">Area Clienti</h1>
  </div>
</header>

<main>
<!-- LOGIN CLIENTE -->
<div id="loginBox">
  <h2>üîê Accesso Clienti</h2>
  <input id="loginEmail" placeholder="Ragione Sociale"
    onkeydown="if(event.key==='Enter') login()" />
  <input id="loginPassword" type="password" placeholder="Password"
    onkeydown="if(event.key==='Enter') login()" />
  <button onclick="login()">Accedi</button>
  <div id="loginErrore" style="color:red;"></div>
</div>

  <!-- CONTENUTO AREA CLIENTI -->
  <div id="contenutoCliente" class="hidden">

    <!-- SEZIONE NUOVA PRENOTAZIONE -->
    <section id="formPrenotazione" class="section">
      <h2>üì¶ Nuova Prenotazione</h2>
      <form id="form">
        <label>Codice CER</label>
        <input name="codiceCER" required />

        <label>Pericolosit√† (HP)</label>
        <select name="pericolosita">
          <option value="">Nessuna</option>
          ${Array.from({ length: 15 }, (_, i) => `<option>HP${i + 1}</option>`).join("")}
        </select>

        <label>Tipo Imballo</label>
        <input name="tipoImballo" required />

        <label>Stato Fisico</label>
        <select name="statoFisico" required>
          <option>Solido</option>
          <option>Liquido</option>
          <option>Fangoso</option>
          <option>Polverulento</option>
          <option>Pasta</option>
          <option>Solido impregnato</option>
          <option>Gassoso</option>
          <option>Aerosol</option>
          <option>Miscela</option>
          <option>Emulsione</option>
        </select>

        <label>Quantit√† (kg)</label>
        <input name="quantita" type="number" required />

        <label>Data Ritiro</label>
        <input name="data" type="date" required />

        <label>Allega Analisi (PDF)</label>
        <input name="analisi" type="file" accept=".pdf" />

        <button type="submit">üì® Invia Prenotazione</button>
        <div id="msgRisultato"></div>
      </form>
    </section>

    <!-- ARCHIVIO PRENOTAZIONI -->
    <section id="archivioPrenotazioni" class="section">
      <h2>üìÅ Le Tue Prenotazioni</h2>
      <div id="contenitorePrenotazioni"></div>
    </section>

  </div>
</main>

<footer>
  üìç Via delle Industrie ‚Äì Zona Asi - 80011 Acerra (NA)<br />
  üìû 081.8857480 / 081.5207650<br />
  ‚úâÔ∏è <a href="mailto:info@ecodrinsrl.it">info@ecodrinsrl.it</a> / <a href="mailto:impianto@ecodrinsrl.it">impianto@ecodrinsrl.it</a><br />
  ¬©2025 Eco.Drin s.r.l. ‚Äì P.I: 03378791218
</footer>


 <!-- parte 2 -->


  <script>
let utente = null;
const chatTimers = {};
const chatLastMessage = {};

document.getElementById("form").addEventListener("submit", async e => {
  e.preventDefault();
  const form = e.target;
  const formData = new FormData(form);

  formData.append("ragioneSociale", utente.ragioneSociale);
  formData.append("codiceCliente", utente.codiceCliente);
  formData.append("produttore", utente.ragioneSociale);
  formData.append("email", utente.email);

  document.getElementById("msgRisultato").textContent = "‚è≥ Invio in corso...";

  try {
    const res = await fetch("/api/prenotazioni", { method: "POST", body: formData });
    if (!res.ok) throw new Error();
    form.reset();
    document.getElementById("msgRisultato").textContent = "‚úÖ Prenotazione inviata!";
    caricaPrenotazioni();
  } catch (err) {
    document.getElementById("msgRisultato").textContent = "‚ùå Errore nell'invio. Riprova.";
  }
});

function login() {
  const ragioneSociale = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ragioneSociale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === "cliente") {
      utente = json.utente;
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("contenutoCliente").classList.remove("hidden");
      caricaPrenotazioni();
    } else throw new Error();
  })
  .catch(() => document.getElementById("loginErrore").innerText = "‚ùå Login fallito.");
}

async function caricaPrenotazioni() {
  const res = await fetch(`/api/prenotazioni/utente/${utente.codiceCliente}`);
  const dati = await res.json();
  const contenitore = document.getElementById("contenitorePrenotazioni");
  contenitore.innerHTML = "";

  const gruppi = {};
  dati.forEach(p => {
    if (p.data) {
      if (!gruppi[p.data]) gruppi[p.data] = [];
      gruppi[p.data].push(p);
    }
  });

  const giorni = Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a));
  if (!giorni.length) return contenitore.innerHTML = "<p>Nessuna prenotazione trovata.</p>";

  giorni.forEach(data => {
    const wrapper = document.createElement("div");

    const toggle = document.createElement("div");
    toggle.className = "giorno-blocco";
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => wrapper.querySelector(".prenotazioni-giorno").classList.toggle("hidden");

    const contenuto = document.createElement("div");
    contenuto.className = "prenotazioni-giorno hidden";

    gruppi[data].forEach(p => {
      const div = document.createElement("div");
      div.className = "prenotazione";
      div.innerHTML = `
        <b>CER:</b> ${p.codiceCER} | <b>Quantit√†:</b> ${p.quantita} kg<br>
        <b>Pericolosit√†:</b> ${p.pericolosita || "N/D"} | <b>Stato:</b> ${p.stato}<br>
        <b>Data:</b> ${formattaData(p.data)}<br>
        ${p.analisi ? `<b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">üìé Visualizza</a><br>` : ""}
        <b>Chat:</b>
        <div class="chat-messaggi" id="chatMsg-${p.id}">Caricamento...</div>
        <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio..." />
        <button onclick="inviaMessaggio(${p.id})">üì® Invia</button>
      `;
      contenuto.appendChild(div);
      caricaChat(p.id);
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    contenitore.appendChild(wrapper);
  });
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chatMsg-${id}`);
  if (!box) return;

  const lastMsg = chat[chat.length - 1];
  const lastKnown = chatLastMessage[id]?.timestamp;
  if (lastMsg && (!lastKnown || lastMsg.timestamp > lastKnown) && lastMsg.autore !== utente.ragioneSociale) {
    if (Notification.permission === "granted") {
      new Notification("üì¨ Nuovo messaggio da amministratore", { body: lastMsg.testo });
    }
    try { new Audio("/sounds/notify.mp3").play(); } catch (e) {}
  }

  chatLastMessage[id] = lastMsg;

  box.innerHTML = chat.map(m => `
    <div class="msg"><b>${m.autore}</b>: ${m.testo}<br>
    <small>${new Date(m.timestamp).toLocaleString()}</small></div>
  `).join('');
  box.scrollTop = box.scrollHeight;

  if (!chatTimers[id]) {
    chatTimers[id] = setInterval(() => caricaChat(id), 2000);
  }
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`inputMsg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: utente.ragioneSociale, testo })
  });

  input.value = "";
  caricaChat(id);
}
</script>
</body>
</html>
