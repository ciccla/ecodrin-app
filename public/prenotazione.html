<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Area Cliente – Ecodrin</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f6f8; }
    main { max-width: 800px; margin: 30px auto; background: white; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    h2 { margin-top: 0; }
    input, select, textarea {
      display: block; margin-bottom: 15px; padding: 8px;
      width: 100%; border: 1px solid #ccc; border-radius: 4px;
    }
    button {
      background: #007acc; color: white; padding: 10px 15px;
      border: none; border-radius: 4px; cursor: pointer;
    }
    .hidden { display: none; }
    .chat-box {
      border: 1px solid #ccc; padding: 10px; border-radius: 6px;
      max-height: 300px; overflow-y: auto; background: #f9f9f9; margin-bottom: 10px;
    }
    .msg { background: #fff; padding: 8px; margin-bottom: 6px;
      border-left: 4px solid #007acc; border-radius: 4px; }
    .msg small { display: block; font-size: 11px; color: #555; }
  </style>
</head>
<body>

<main>
  <div id="authBox">
    <h2>Accesso Clienti</h2>
    <input id="loginEmail" placeholder="Ragione Sociale">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <p><a href="#" onclick="toggleRegistro()">Non hai un account? Registrati</a></p>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <div id="regBox" class="hidden">
    <h2>Registrazione</h2>
    <input id="regRagione" placeholder="Ragione Sociale">
    <input id="regCF" placeholder="Codice Fiscale">
    <input id="regPassword" type="password" placeholder="Password">
    <button onclick="registrati()">Registrati</button>
    <p><a href="#" onclick="toggleRegistro()">Hai già un account? Login</a></p>
    <div id="regErrore" style="color:red;"></div>
  </div>

  <div id="clienteBox" class="hidden">
    <h2>Benvenuto, <span id="nomeCliente"></span></h2>

    <h3>📦 Prenotazione Rifiuti</h3>
    <form id="formPrenotazione">
      <input name="produttore" placeholder="Produttore" required>
      <input name="codiceCER" placeholder="Codice CER" required>
      <input name="quantita" type="number" placeholder="Quantità (kg)" required>
      <select name="pericolosita">
        <option value="">Pericolosità</option>
        <option value="HP1">HP1</option>
        <option value="HP2">HP2</option>
      </select>
      <input name="tipoImballo" placeholder="Tipo Imballo">
      <input name="statoFisico" placeholder="Stato Fisico">
      <input name="data" type="date" required>
      <input name="analisi" type="file" />
      <button type="submit">Invia Prenotazione</button>
    </form>

    <h3>💬 Le Tue Prenotazioni</h3>
    <div id="prenotazioni"></div>
  </div>
</main><script>
let cliente = null;

function toggleRegistro() {
  document.getElementById('authBox').classList.toggle('hidden');
  document.getElementById('regBox').classList.toggle('hidden');
  document.getElementById('loginErrore').innerText = '';
  document.getElementById('regErrore').innerText = '';
}

function login() {
  const ragioneSociale = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === 'cliente') {
      cliente = json.utente;
      document.getElementById('nomeCliente').innerText = cliente.ragioneSociale;
      document.getElementById('authBox').classList.add('hidden');
      document.getElementById('clienteBox').classList.remove('hidden');
      caricaPrenotazioni();
    } else {
      throw new Error();
    }
  })
  .catch(() => {
    document.getElementById('loginErrore').innerText = '❌ Credenziali errate';
  });
}

document.getElementById('loginPassword').addEventListener('keydown', e => {
  if (e.key === 'Enter') login();
});

function registrati() {
  const ragioneSociale = document.getElementById('regRagione').value.trim();
  const codiceFiscale = document.getElementById('regCF').value.trim();
  const password = document.getElementById('regPassword').value.trim();

  fetch('/api/registrazione', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale, codiceFiscale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(() => {
    alert('Registrazione completata!');
    toggleRegistro();
  })
  .catch(() => {
    document.getElementById('regErrore').innerText = '⚠️ Errore nella registrazione';
  });
}

document.getElementById('formPrenotazione').addEventListener('submit', e => {
  e.preventDefault();
  const form = e.target;
  const dati = new FormData(form);
  dati.append('email', cliente.email);
  dati.append('codiceCliente', cliente.codiceCliente);
  dati.append('ragioneSociale', cliente.ragioneSociale);

  fetch('/api/prenotazioni', {
    method: 'POST',
    body: dati
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(() => {
    alert('Prenotazione inviata');
    form.reset();
    caricaPrenotazioni();
  })
  .catch(() => alert('Errore nella prenotazione'));
});

async function caricaPrenotazioni() {
  const res = await fetch(`/api/prenotazioni/utente/${cliente.codiceCliente}`);
  const lista = await res.json();
  const div = document.getElementById('prenotazioni');
  div.innerHTML = '';

  if (!lista.length) {
    div.innerHTML = '<p style="color:gray;">Nessuna prenotazione inviata.</p>';
    return;
  }

  lista.sort((a,b) => new Date(b.data) - new Date(a.data));

  for (const p of lista) {
    const box = document.createElement('div');
    box.style.border = '1px solid #ccc';
    box.style.padding = '10px';
    box.style.margin = '10px 0';
    box.style.borderRadius = '6px';

    box.innerHTML = `
      <b>Data:</b> ${p.data}<br>
      <b>CER:</b> ${p.codiceCER} – <b>Quantità:</b> ${p.quantita} kg<br>
      <b>Stato:</b> ${p.stato}<br>
      <div class="chat-box" id="chat-${p.id}">Caricamento messaggi...</div>
      <input id="msg-${p.id}" placeholder="Scrivi un messaggio..." />
      <button onclick="inviaMessaggio(${p.id})">📨</button>
    `;

    div.appendChild(box);
    caricaChat(p.id);

    setTimeout(() => {
      const input = document.getElementById(`msg-${p.id}`);
      input?.addEventListener('keydown', e => {
        if (e.key === 'Enter') inviaMessaggio(p.id);
      });
    }, 100);
  }
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chat-${id}`);
  box.innerHTML = chat.map(m => `
    <div class="msg">
      <b>${m.autore}</b>: ${m.testo}<br>
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>`).join('');
  box.scrollTop = box.scrollHeight;
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`msg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: cliente.ragioneSociale, testo })
  });
  input.value = '';
  caricaChat(id);
}
</script>
</body>
</html>

