<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Area Cliente â€“ Ecodrin</title>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f6f8; }
    main {
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    input, button, select, textarea {
      width: 100%; padding: 10px; margin-top: 10px;
      font-size: 15px; border: 1px solid #ccc; border-radius: 5px;
    }
    button { background: #007acc; color: white; cursor: pointer; font-weight: bold; }
    .menu {
      margin: 20px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }
    .hidden { display: none; }
    .messaggio {
      background: #eef2f5; padding: 8px; margin-top: 5px; border-radius: 4px;
    }
    .messaggio small { font-size: 11px; color: #666; display: block; }
    .badge {
      display: none; background: red; color: white;
      padding: 2px 6px; font-size: 12px; border-radius: 10px; margin-left: 5px;
    }
    .badge.show { display: inline-block; animation: pulse 1s infinite; }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
<main>
  <h1 style="text-align:center;">ğŸ“¦ Area Cliente â€“ Ecodrin</h1>
  <div id="menuCliente" class="menu hidden">
    <div id="nomeUtente" style="font-weight:bold;"></div>
    <select id="menuSelect" onchange="gestisciMenu(this)">
      <option value="">ğŸ§­ Menu</option>
      <option value="formBox">â• Nuova Prenotazione</option>
      <option value="storicoBox">ğŸ“‹ Storico</option>
      <option value="logout">ğŸšª Logout</option>
    </select>
  </div>

  <!-- LOGIN -->
  <div id="loginBox">
    <h2>ğŸ” Login</h2>
    <input id="loginEmail" placeholder="Ragione Sociale">
    <input id="loginPassword" type="password" placeholder="Password">
    <button onclick="login()">Accedi</button>
    <p>Non sei registrato? <a href="#" onclick="switchToRegister()">Registrati</a></p>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <!-- REGISTRAZIONE -->
  <div id="registerBox" class="hidden">
    <h2>ğŸ“ Registrazione</h2>
    <input id="regRagione" placeholder="Ragione Sociale">
    <input id="regCF" placeholder="Codice Fiscale / P.IVA">
    <input id="regPassword" type="password" placeholder="Password">
    <button onclick="registrati()">Registrati</button>
    <p>Hai giÃ  un account? <a href="#" onclick="switchToLogin()">Accedi</a></p>
    <div id="regMsg"></div>
  </div>

  <!-- FORM PRENOTAZIONE -->
  <div id="formBox" class="hidden">
    <h2>â• Nuova Prenotazione</h2>
    <form id="formPrenotazione">
      <input type="date" name="data" required>
      <input name="produttore" placeholder="Produttore" required>
      <input name="codiceCER" placeholder="Codice CER" required>
      <input name="quantita" type="number" step="0.1" placeholder="QuantitÃ  (kg)" required>
      <input name="statoFisico" placeholder="Stato fisico" required>
      <input name="tipoImballo" placeholder="Tipo imballo" required>
      <input name="pericolosita" placeholder="PericolositÃ  (es: HP1)">
      <textarea name="note" placeholder="Note aggiuntive"></textarea>
      <input type="file" name="analisi" accept="application/pdf">
      <button type="submit">ğŸ“¤ Invia</button>
    </form>
    <div id="successMsg" style="color:green;"></div>
  </div>

  <!-- STORICO -->
  <div id="storicoBox" class="hidden">
    <h2>ğŸ“‹ Storico Prenotazioni</h2>
    <div id="storicoTable"></div>
  </div>
</main>

<script>
let utente = null;
let ultimaChatCliente = {};

function switchToRegister() {
  document.getElementById('loginBox').classList.add('hidden');
  document.getElementById('registerBox').classList.remove('hidden');
}
function switchToLogin() {
  document.getElementById('registerBox').classList.add('hidden');
  document.getElementById('loginBox').classList.remove('hidden');
}
function mostra(sezione) {
  ['formBox', 'storicoBox'].forEach(id => document.getElementById(id).classList.add('hidden'));
  document.getElementById(sezione).classList.remove('hidden');
}
function mostraMenu() {
  document.getElementById('nomeUtente').textContent = `ğŸ‘¤ ${utente.ragioneSociale}`;
  document.getElementById('menuCliente').classList.remove('hidden');
}

function gestisciMenu(sel) {
  const scelta = sel.value;
  if (scelta === 'logout') return logout();
  if (scelta) mostra(scelta);
  sel.selectedIndex = 0;
}

function login() {
  const ragioneSociale = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('http://localhost:3000/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    utente = json.utente;
    localStorage.setItem('utente', JSON.stringify(utente));
    document.getElementById('loginBox').classList.add('hidden');
    mostraMenu();
    mostra('formBox');
    caricaStorico();
  })
  .catch(() => document.getElementById('loginErrore').innerText = 'âŒ Login fallito');
}

document.getElementById('loginPassword').addEventListener('keydown', e => {
  if (e.key === 'Enter') login();
});

function registrati() {
  const ragione = document.getElementById('regRagione').value.trim();
  const cf = document.getElementById('regCF').value.trim();
  const password = document.getElementById('regPassword').value.trim();

  fetch('http://localhost:3000/api/registrazione', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale: ragione, codiceFiscale: cf, password })
  })
  .then(res => res.json())
  .then(() => {
    document.getElementById('regMsg').innerText = 'âœ… Registrazione completata!';
    switchToLogin();
  })
  .catch(() => document.getElementById('regMsg').innerText = 'âŒ Errore registrazione');
}

function logout() {
  localStorage.removeItem('utente');
  utente = null;
  location.reload();
}

document.getElementById('formPrenotazione').addEventListener('submit', async (e) => {
  e.preventDefault();
  const form = e.target;
  const dati = new FormData(form);
  dati.append('codiceCliente', utente.codiceCliente);
  dati.append('ragioneSociale', utente.ragioneSociale);
  dati.append('email', utente.email);

  const res = await fetch('http://localhost:3000/api/prenotazioni', {
    method: 'POST',
    body: dati
  });

  if (res.ok) {
    document.getElementById('successMsg').innerText = 'âœ… Prenotazione inviata!';
    form.reset();
    caricaStorico();
    mostra('storicoBox');
  }
});

async function caricaStorico() {
  const res = await fetch(`http://localhost:3000/api/prenotazioni/utente/${utente.codiceCliente}`);
  const dati = await res.json();
  const container = document.getElementById('storicoTable');
  container.innerHTML = '';

  dati.forEach(p => {
    const div = document.createElement('div');
    div.className = 'prenotazione';
    div.id = `pren-${p.id}`;
    div.innerHTML = `
      <div><b>Data:</b> ${p.data}</div>
      <div><b>CER:</b> ${p.codiceCER}</div>
      <div><b>QuantitÃ :</b> ${p.quantita} kg</div>
      <div><b>Stato:</b> ${p.stato}</div>
      <div><b>PDF:</b> ${p.analisi ? `<a href="http://localhost:3000/uploads/${p.analisi}" target="_blank">ğŸ“„</a>` : 'Nessuno'}</div>
      <div>
        <b>Chat:</b>
        <span class="badge" id="badge-${p.id}">ğŸ›ï¸</span>
        <div id="chatMsg-${p.id}"></div>
        <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio.">
        <button type="button" onclick="inviaMessaggio(${p.id})">ğŸ“¨</button>
      </div>
    `;
    container.appendChild(div);
    caricaChat(p.id);

    // âœ… Enter per inviare chat
    setTimeout(() => {
      const input = document.getElementById(`inputMsg-${p.id}`);
      input?.addEventListener('keydown', e => {
        if (e.key === 'Enter') inviaMessaggio(p.id);
      });
    }, 100);
  });
}

async function caricaChat(id) {
  const res = await fetch(`http://localhost:3000/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const key = JSON.stringify(chat);
  const box = document.getElementById(`chatMsg-${id}`);
  const badge = document.getElementById(`badge-${id}`);

  if (key === ultimaChatCliente[id]) return;
  ultimaChatCliente[id] = key;

  if (chat.length && chat[chat.length - 1].autore === 'admin') {
    badge?.classList.add('show');
  }

  box.innerHTML = chat.map(m => `
    <div class="messaggio">
      <small><b>${m.autore}</b> â€“ ${new Date(m.timestamp).toLocaleString()}</small>
      ${m.testo}
    </div>
  `).join('');
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`inputMsg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`http://localhost:3000/api/prenotazioni/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: utente.ragioneSociale, testo })
  });

  input.value = '';
  document.getElementById(`badge-${id}`)?.classList.remove('show');
  caricaChat(id);
}

window.onload = () => {
  const saved = localStorage.getItem('utente');
  if (saved) {
    utente = JSON.parse(saved);
    document.getElementById('loginBox').classList.add('hidden');
    mostraMenu();
    mostra('formBox');
    caricaStorico();
  }
};

setInterval(() => {
  if (!utente) return;
  document.querySelectorAll('.prenotazione').forEach(div => {
    const id = div.id.split('-')[1];
    caricaChat(id);
  });
}, 3000);
</script>
</body>
</html>
