<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Ecodrin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f6f8; color: #111; transition: 0.3s; }
    body.dark { background: #121212; color: #f0f0f0; }
    main {
      max-width: 1100px; margin: 30px auto;
      background: white; padding: 30px; border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    body.dark main { background: #1e1e1e; box-shadow: 0 4px 10px rgba(0,0,0,0.6); }
    header {
      background: #007acc; color: white;
      padding: 15px 30px; display: flex;
      justify-content: space-between; align-items: center;
    }
    .hidden { display: none; }
    .giorno h3 {
      background: #007acc; color: white;
      padding: 10px; cursor: pointer;
      margin: 0; border-radius: 6px;
    }
    .contenuto { padding: 10px; display: none; }
    .prenotazione {
      background: #f9f9f9; padding: 10px;
      margin-bottom: 10px; border-radius: 6px;
    }
    body.dark .prenotazione { background: #2a2a2a; }
    .chat { margin-top: 10px; }
    .chat-messaggi {
      max-height: 150px; overflow-y: auto;
      background: white; padding: 10px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    body.dark .chat-messaggi { background: #333; border-color: #555; }
    .messaggio {
      margin-bottom: 6px;
      background: #e0f0ff; padding: 6px;
      border-radius: 5px;
    }
    body.dark .messaggio { background: #444; }
    .badge {
      background: red; color: white;
      padding: 2px 6px; border-radius: 12px;
      font-size: 12px; display: none;
    }
    .badge.show { display: inline-block; }
    .top-bar {
      display: flex; justify-content: space-between;
      align-items: center;
    }
    .dark-toggle {
      background: #fff; border: none; border-radius: 4px;
      padding: 6px 10px; cursor: pointer;
      color: #333;
    }
  </style>
</head>
<body>

<header class="hidden" id="adminHeader">
  <h1>ğŸ“Š Pannello Admin â€“ Ecodrin</h1>
  <div>
    <select onchange="switchPage(this.value)">
      <option value="registro">ğŸ“‹ Registro</option>
      <option value="trasporti">ğŸš› Trasporti</option>
      <option value="statistiche">ğŸ“ˆ Statistiche</option>
    </select>
    <button class="dark-toggle" onclick="toggleDark()">ğŸŒ“</button>
    <button onclick="logout()">ğŸšª Logout</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <div id="loginBox">
    <h2>ğŸ” Login Admin</h2>
    <input id="loginEmail" placeholder="Email" onkeydown="if(event.key==='Enter') login()">
    <input id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">Accedi</button>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <!-- CONTENUTO ADMIN -->
  <div id="contenutoAdmin" class="hidden">
    <!-- Prenotazioni -->
    <div id="paginaRegistro">
      <h2>ğŸ“‹ Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </div>

    <!-- Trasporti -->
    <div id="paginaTrasporti" class="hidden">
      <h2>ğŸš› Registro Trasporti</h2>
      <div id="contenitoreTrasporti"></div>
    </div>

    <!-- Statistiche -->
    <div id="paginaStatistiche" class="hidden">
      <div class="top-bar">
        <h2>ğŸ“ˆ Statistiche CER</h2>
        <button onclick="esportaCSV()">ğŸ“¤ Esporta CSV</button>
      </div>
      <canvas id="graficoCER"></canvas>
    </div>
  </div>

<audio id="suonoNotifica" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9ce296083a.mp3" preload="auto"></audio>


  <!-- parte 2-->
<script>
let prenotazioni = [];
let ultimaChat = {};
let suono = document.getElementById("suonoNotifica");

function toggleDark() {
  document.body.classList.toggle("dark");
}

function login() {
  const email = document.getElementById("loginEmail").value;
  const password = document.getElementById("loginPassword").value;
  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.json())
  .then(json => {
    if (json.tipo === "admin") {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("adminHeader").classList.remove("hidden");
      document.getElementById("contenutoAdmin").classList.remove("hidden");
      mostraPagina("registro");
      caricaPrenotazioni();
      caricaTrasporti();
    }
  })
  .catch(() => document.getElementById("loginErrore").innerText = "âŒ Login errato");
}

function logout() {
  location.reload();
}

function switchPage(val) {
  mostraPagina(val);
}

function mostraPagina(pagina) {
  ["paginaRegistro", "paginaTrasporti", "paginaStatistiche"].forEach(id => {
    document.getElementById(id).classList.add("hidden");
  });
  document.getElementById("pagina" + capitalize(pagina)).classList.remove("hidden");
  if (pagina === "statistiche") caricaStatistiche();
}

function capitalize(s) {
  return s.charAt(0).toUpperCase() + s.slice(1);
}

function caricaPrenotazioni() {
  fetch("/api/prenotazioni")
    .then(res => res.json())
    .then(dati => {
      prenotazioni = dati;
      const gruppi = {};
      dati.forEach(p => {
        if (!gruppi[p.data]) gruppi[p.data] = [];
        gruppi[p.data].push(p);
      });

      const contenitore = document.getElementById("contenitoreGiorni");
      contenitore.innerHTML = "";

      Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
        const box = document.createElement("div");
        box.className = "giorno";
        box.innerHTML = `<h3 onclick="toggleGiorno(this)">${data} (${gruppi[data].length})</h3>`;
        const contenuto = document.createElement("div");
        contenuto.className = "contenuto";

        gruppi[data].forEach(p => {
          const div = document.createElement("div");
          div.className = "prenotazione";
          div.innerHTML = `
            <b>${p.ragioneSociale}</b><br>
            <b>Produttore:</b> ${p.produttore}<br>
            <b>CER:</b> ${p.codiceCER} â€“ <b>${p.quantita} kg</b><br>
            <b>Stato:</b>
            <select onchange="aggiornaStato(${p.id}, this.value)">
              <option ${p.stato==="in attesa"?"selected":""}>in attesa</option>
              <option ${p.stato==="confermata"?"selected":""}>confermata</option>
              <option ${p.stato==="rifiutata"?"selected":""}>rifiutata</option>
            </select><br>
            ${p.analisi ? `<b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">ğŸ“„</a><br>` : ""}
            <div class="chat">
              <div class="chat-messaggi" id="chat-${p.id}"></div>
              <input id="input-${p.id}" placeholder="Scrivi..." onkeydown="if(event.key==='Enter') invia(${p.id})">
              <button onclick="invia(${p.id})">ğŸ“¨</button>
            </div>`;
          contenuto.appendChild(div);
          caricaChat(p.id);
        });

        box.appendChild(contenuto);
        contenitore.appendChild(box);
      });
    });
}

function aggiornaStato(id, stato) {
  fetch(`/api/prenotazioni/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stato })
  });
}

function toggleGiorno(h3) {
  const div = h3.nextElementSibling;
  div.style.display = div.style.display === "block" ? "none" : "block";
}

function caricaChat(id) {
  fetch(`/api/prenotazioni/${id}/chat`)
    .then(res => res.json())
    .then(chat => {
      const box = document.getElementById(`chat-${id}`);
      const key = JSON.stringify(chat);
      if (ultimaChat[id] && ultimaChat[id] !== key) {
        suono.play();
        document.querySelector(`#chat-${id}`)?.parentElement.querySelector('.badge')?.classList?.add("show");
      }
      ultimaChat[id] = key;
      if (!box) return;
      box.innerHTML = chat.map(m => `
        <div class="messaggio">
          <small><b>${m.autore}</b> â€“ ${new Date(m.timestamp).toLocaleString()}</small>
          ${m.testo}
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    });
}

function invia(id) {
  const input = document.getElementById(`input-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  fetch(`/api/prenotazioni/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: "impianto", testo })
  }).then(() => {
    input.value = "";
    caricaChat(id);
  });
}

function caricaTrasporti() {
  fetch("/api/trasporti")
    .then(res => res.json())
    .then(lista => {
      const container = document.getElementById("contenitoreTrasporti");
      container.innerHTML = "";
      lista.forEach(p => {
        const box = document.createElement("div");
        box.className = "prenotazione";
        box.innerHTML = `
          <b>${p.ragioneSociale}</b><br>
          <b>Produttore:</b> ${p.produttore}<br>
          <b>CER:</b> ${p.codiceCER} â€“ <b>${p.tipoTrasporto}</b><br>
          <b>Data:</b> ${p.dataTrasporto} â€“ <b>${p.fasciaOraria}</b><br>
          <b>Referente:</b> ${p.referente} â€“ ${p.cellulare}<br>
          <b>Prezzo:</b> â‚¬ ${p.prezzo}
        `;
        container.appendChild(box);
      });
    });
}

function caricaStatistiche() {
  const cer = {};
  prenotazioni.forEach(p => {
    if (!cer[p.codiceCER]) cer[p.codiceCER] = 0;
    cer[p.codiceCER] += Number(p.quantita || 0);
  });
  const ctx = document.getElementById("graficoCER").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(cer),
      datasets: [{
        data: Object.values(cer),
        backgroundColor: ['#00785c', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#28a745', '#20c997']
      }]
    }
  });
}

function esportaCSV() {
  const righe = [["Cliente", "Produttore", "CER", "QuantitÃ ", "Data", "Stato"]];
  prenotazioni.forEach(p => {
    righe.push([p.ragioneSociale, p.produttore, p.codiceCER, p.quantita, p.data, p.stato]);
  });
  const csv = righe.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "prenotazioni.csv";
  link.click();
}
</script>
</body>
</html>

  
