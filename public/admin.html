<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin ‚Äì Eco.Drin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f1f4f6;
      color: #333;
    }

    header {
      background-color: #004c45;
      color: white;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }

    header img {
      height: 50px;
    }

    .menu-dropdown {
      position: relative;
    }

    .menu-dropdown button {
      background: #00785c;
      color: white;
      border: none;
      padding: 10px 15px;
      font-weight: bold;
      border-radius: 4px;
      cursor: pointer;
    }

    .menu-dropdown-content {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      background-color: white;
      min-width: 160px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
    }

    .menu-dropdown-content a {
      color: #004c45;
      padding: 10px 15px;
      text-decoration: none;
      display: block;
    }

    .menu-dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .menu-dropdown.hidden {
      display: none;
    }

    .menu-dropdown:hover .menu-dropdown-content {
      display: block;
    }

    main {
      max-width: 1100px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    h2 {
      margin-top: 0;
      color: #004c45;
    }

    .hidden {
      display: none;
    }

    .card-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      flex: 1 1 200px;
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      text-align: center;
    }

    .card h3 {
      margin: 0;
      font-size: 22px;
      color: #00785c;
    }

    .card p {
      margin: 10px 0 0;
      font-size: 16px;
    }

    .giorno-blocco {
      background: #eafaf5;
      padding: 12px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      margin-top: 20px;
      border: 1px solid #b3e5c5;
    }

    .prenotazione {
      background: #fff;
      border: 1px solid #ccc;
      padding: 15px;
      margin: 10px 0;
      border-radius: 6px;
    }

    footer {
      text-align: center;
      font-size: 14px;
      padding: 20px;
      color: #777;
      margin-top: 40px;
    }
  </style>
</head>

<body>
<header>
  <div style="display:flex; align-items:center; gap:15px;">
    <a href="index.html"><img src="eco.drin-_srl.png" alt="Logo Ecodrin" /></a>
    <h1 style="margin:0;">Area Amministrativa</h1>
  </div>
  <div class="menu-dropdown hidden" id="menuAdmin">
    <button>üìÇ Menu</button>
    <div class="menu-dropdown-content">
      <a href="#" onclick="switchPage('registro')">üìã Registro</a>
      <a href="#" onclick="switchPage('statistiche')">üìà Statistiche</a>
      <a href="#" onclick="logout()">üö™ Logout</a>
    </div>
  </div>
</header>

<main>
 <!-- LOGIN ADMIN -->
<div id="loginBox">
  <h2>üîê Accesso Amministratore</h2>
  <input id="loginEmail" placeholder="Email"
    onkeydown="if(event.key==='Enter') login()" />
  <input id="loginPassword" type="password" placeholder="Password"
    onkeydown="if(event.key==='Enter') login()" />
  <button onclick="login()">Accedi</button>
  <div id="loginErrore" style="color:red;"></div>
</div>

  <!-- CONTENUTO ADMIN -->
  <div id="contenutoAdmin" class="hidden">

    <!-- REGISTRO -->
    <section id="paginaRegistro">
      <h2>üìã Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </section>

    <!-- STATISTICHE -->
    <section id="paginaStatistiche" class="hidden">
      <h2>üìà Statistiche</h2>
      <div class="card-grid" id="statCards"></div>
      <canvas id="graficoCER" style="max-width:600px; margin:0 auto;"></canvas>
      <ul id="statistiche" style="margin-top:30px;"></ul>
    </section>

  </div>
</main>

<footer>
  üìç Via delle Industrie ‚Äì Zona Asi - 80011 Acerra (NA)<br />
  üìû 081.8857480 / 081.5207650<br />
  ‚úâÔ∏è <a href="mailto:info@ecodrinsrl.it">info@ecodrinsrl.it</a> / <a href="mailto:impianto@ecodrinsrl.it">impianto@ecodrinsrl.it</a><br />
  ¬©2025 Eco.Drin s.r.l. ‚Äì P.I: 03378791218
</footer>




  <!-- parte 2-->


  <script>
let adminAutenticato = false;
const chatTimers = {};
const chatLastMessage = {};

if ("Notification" in window) Notification.requestPermission();

function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === 'admin') {
      adminAutenticato = true;
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('contenutoAdmin').classList.remove('hidden');
      document.getElementById('menuAdmin').classList.remove('hidden');
      caricaPrenotazioni();
      caricaStatistiche();
    } else throw new Error();
  })
  .catch(() => document.getElementById('loginErrore').innerText = '‚ùå Credenziali errate');
}

function logout() {
  location.reload();
}

function switchPage(pagina) {
  document.getElementById('paginaRegistro').classList.add('hidden');
  document.getElementById('paginaStatistiche').classList.add('hidden');
  document.getElementById(`pagina${pagina.charAt(0).toUpperCase() + pagina.slice(1)}`).classList.remove('hidden');
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

async function caricaPrenotazioni() {
  const res = await fetch('/api/prenotazioni');
  const dati = await res.json();
  const contenitore = document.getElementById('contenitoreGiorni');
  contenitore.innerHTML = '';

  const gruppi = {};
  dati.forEach(p => {
    if (p.data) {
      if (!gruppi[p.data]) gruppi[p.data] = [];
      gruppi[p.data].push(p);
    }
  });

  const giorni = Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a));
  if (!giorni.length) return contenitore.innerHTML = '<p>Nessuna prenotazione.</p>';

  giorni.forEach(data => {
    const wrapper = document.createElement('div');

    const toggle = document.createElement('div');
    toggle.className = 'giorno-blocco';
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => wrapper.querySelector('.prenotazioni-giorno').classList.toggle('hidden');

    const contenuto = document.createElement('div');
    contenuto.className = 'prenotazioni-giorno hidden';

    gruppi[data].forEach(p => {
      const div = document.createElement('div');
      div.className = 'prenotazione';
      div.innerHTML = `
        <b>Cliente:</b> ${p.ragioneSociale} (${p.codiceCliente})<br>
        <b>CER:</b> ${p.codiceCER} | <b>Quantit√†:</b> ${p.quantita} kg<br>
        <b>Data:</b> ${p.data} | <b>Pericolosit√†:</b> ${p.pericolosita || 'N/D'}<br>
        <b>Imballo:</b> ${p.tipoImballo || 'N/D'} | <b>Stato Fisico:</b> ${p.statoFisico || 'N/D'}<br>
        ${p.analisi ? `<b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">üìé Visualizza</a><br>` : ''}
        <b>Stato:</b>
        <select onchange="aggiornaStato(${p.id}, this.value)">
          <option value="in attesa" ${p.stato === 'in attesa' ? 'selected' : ''}>‚è≥ In attesa</option>
          <option value="confermata" ${p.stato === 'confermata' ? 'selected' : ''}>‚úÖ Confermata</option>
          <option value="rifiutata" ${p.stato === 'rifiutata' ? 'selected' : ''}>‚ùå Rifiutata</option>
        </select>

        <div class="chat" style="margin-top:15px;">
          <b>Chat:</b>
          <div class="chat-messaggi" id="chatMsg-${p.id}">Caricamento...</div>
          <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter'){inviaMessaggio(${p.id})}" />
          <button onclick="inviaMessaggio(${p.id})" class="btn-green">üì® Invia</button>
        </div>
      `;
      contenuto.appendChild(div);
      caricaChat(p.id);
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    contenitore.appendChild(wrapper);
  });
}

async function aggiornaStato(id, stato) {
  await fetch(`/api/prenotazioni/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ stato })
  });
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chatMsg-${id}`);
  if (!box) return;

  const lastMsg = chat[chat.length - 1];
  const lastKnown = chatLastMessage[id]?.timestamp;
  if (
    lastMsg &&
    (!lastKnown || lastMsg.timestamp > lastKnown) &&
    lastMsg.autore !== 'impianto'
  ) {
    if (Notification.permission === "granted") {
      new Notification("üì¨ Nuovo messaggio da cliente", { body: lastMsg.testo });
    }
    try { new Audio("/sounds/notify.mp3").play(); } catch(e) {}
  }

  chatLastMessage[id] = lastMsg;

  box.innerHTML = chat.map(m => `
    <div class="msg">
      <b>${m.autore}</b>: ${m.testo}
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;

  if (!chatTimers[id]) {
    chatTimers[id] = setInterval(() => caricaChat(id), 2000);
  }
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`inputMsg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: "impianto", testo })
  });

  input.value = "";
  caricaChat(id);
}

async function caricaStatistiche() {
  const res = await fetch('/api/prenotazioni');
  const dati = await res.json();

  const clientiUnici = [...new Set(dati.map(p => p.ragioneSociale))].length;
  const totalePrenotazioni = dati.length;
  const totaleKg = dati.reduce((sum, p) => sum + Number(p.quantita || 0), 0);
  const stati = { 'confermata': 0, 'rifiutata': 0, 'in attesa': 0 };
  dati.forEach(p => { if (stati[p.stato] !== undefined) stati[p.stato]++; });

  const cardContainer = document.getElementById('statCards');
  cardContainer.innerHTML = `
    <div class="card"><h3>üßë‚Äçüíº ${clientiUnici}</h3><p>Clienti</p></div>
    <div class="card"><h3>üì¶ ${totalePrenotazioni}</h3><p>Prenotazioni</p></div>
    <div class="card"><h3>‚öñÔ∏è ${totaleKg}</h3><p>Totale kg</p></div>
    <div class="card"><h3>‚úÖ ${stati.confermata}</h3><p>Confermate</p></div>
    <div class="card"><h3>‚ùå ${stati.rifiutata}</h3><p>Rifiutate</p></div>
    <div class="card"><h3>‚è≥ ${stati['in attesa']}</h3><p>In Attesa</p></div>
  `;

  const statsCER = {};
  dati.forEach(p => {
    if (!statsCER[p.codiceCER]) statsCER[p.codiceCER] = 0;
    statsCER[p.codiceCER] += Number(p.quantita);
  });

  const labels = Object.keys(statsCER);
  const valori = Object.values(statsCER);

  document.getElementById('statistiche').innerHTML = labels.map((k, i) => `<li>${k}: ${valori[i]} kg</li>`).join('');

  new Chart(document.getElementById('graficoCER'), {
    type: 'pie',
    data: {
      labels,
      datasets: [{
        data: valori,
        backgroundColor: ['#00785c', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#28a745', '#20c997']
      }]
    }
  });
}
</script>
</body>
</html>

 
