<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Eco.Drin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --verde: #004c45;
      --verde-chiaro: #d1fbe3;
      --bg: #f4f6f8;
      --text: #111;
      --box: white;
      --chat-admin: #e9f9ef;
      --chat-user: #c8f7e3;
    }

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }

    body.dark {
      --bg: #121212;
      --text: #f0f0f0;
      --box: #1e1e1e;
      --chat-admin: #333;
      --chat-user: #004c45;
    }

    header {
      background: var(--verde);
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    main {
      max-width: 1100px;
      margin: 30px auto;
      background: var(--box);
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h2 {
      color: var(--verde);
    }

    .hidden { display: none !important; }

    .btn {
      background: #28a745;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn:hover {
      background: #218838;
    }

    .dark-toggle {
      background: white;
      color: var(--verde);
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
    }

    body.dark .dark-toggle {
      background: #2c2c2c;
      color: #d1fbe3;
    }

    .giorno-blocco {
      margin-top: 25px;
      background: var(--verde-chiaro);
      padding: 10px 15px;
      font-weight: bold;
      border-radius: 6px;
      cursor: pointer;
    }

    .prenotazione {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
    }

    body.dark .prenotazione {
      background: #2c2c2c;
      border-color: #555;
    }

    .chat-messaggi {
      max-height: 200px;
      overflow-y: auto;
      background: var(--chat-admin);
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
    }

    .bolla-chat {
      max-width: 90%;
      margin-bottom: 10px;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 14px;
      word-wrap: break-word;
      clear: both;
    }

    .bolla-admin {
      background: var(--chat-admin);
      float: left;
      border-top-left-radius: 0;
    }

    .bolla-user {
      background: var(--chat-user);
      float: right;
      border-top-right-radius: 0;
    }

    .bolla-chat small {
      display: block;
      font-size: 11px;
      opacity: 0.6;
      margin-bottom: 4px;
    }

    .card {
      background: var(--verde-chiaro);
      padding: 20px;
      border-radius: 10px;
      display: inline-block;
      margin: 10px;
      text-align: center;
    }

    .badge {
      background: red;
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      display: none;
    }

    .badge.show {
      display: inline-block;
    }

    @media (max-width: 600px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
      }

      main {
        padding: 20px;
        margin: 10px;
        border-radius: 8px;
      }

      .prenotazione {
        padding: 12px;
        font-size: 15px;
      }

      .chat-messaggi {
        max-height: 250px;
        padding: 10px;
        font-size: 14px;
      }

      input, select {
        width: 100% !important;
        font-size: 15px;
        padding: 10px;
        margin: 6px 0;
      }

      button, .btn, .dark-toggle {
        width: 100%;
        padding: 12px;
        margin-top: 10px;
        font-size: 16px;
        border-radius: 6px;
      }

      .card {
        width: 100% !important;
        box-sizing: border-box;
        margin: 10px 0;
      }

      canvas#graficoCER {
        max-width: 100%;
      }
    }
  </style></style>
</head>
<body>

<header id="adminHeader" class="hidden">
  <h1>üìä Pannello Admin ‚Äì Eco.Drin</h1>
  <div>
    <select onchange="switchPage(this.value)">
      <option value="registro">üìã Registro</option>
      <option value="trasporti">üöõ Trasporti</option>
      <option value="statistiche">üìà Statistiche</option>
    </select>
    <button class="dark-toggle" onclick="toggleDark()">üåì</button>
    <button onclick="logout()" class="btn">üö™ Logout</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <div id="loginBox">
    <h2>üîê Login Admin</h2>
    <input id="loginEmail" placeholder="Email" onkeydown="if(event.key==='Enter') login()" />
    <input id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') login()" />
    <button class="btn" onclick="login()">Accedi</button>
    <div id="loginErrore" style="color:red; margin-top:10px;"></div>
  </div>

  <!-- CONTENUTO ADMIN -->
  <div id="contenutoAdmin" class="hidden">

    <!-- PAGINA REGISTRO -->
    <section id="paginaRegistro">
      <h2>üìÅ Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </section>

    <!-- PAGINA TRASPORTI -->
    <section id="paginaTrasporti" class="hidden">
      <h2>üöõ Registro Trasporti</h2>
      <div id="contenitoreTrasporti"></div>
    </section>

    <!-- PAGINA STATISTICHE -->
    <section id="paginaStatistiche" class="hidden">
      <h2>üìà Statistiche CER</h2>
      <div id="statCards" style="display:flex; flex-wrap:wrap; gap:15px;"></div>
      <canvas id="graficoCER" style="max-width:600px; margin-top:30px;"></canvas>
    </section>
  </div>
</main>

<audio id="suonoNotifica" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9ce296083a.mp3" preload="auto"></audio>
<script>
let adminAutenticato = false;
const ultimaChat = {};

function toggleDark() {
  document.body.classList.toggle('dark');
  localStorage.setItem('darkMode', document.body.classList.contains('dark'));
}

function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === 'admin') {
      adminAutenticato = true;
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('contenutoAdmin').classList.remove('hidden');
      document.getElementById('adminHeader').classList.remove('hidden');
      caricaPrenotazioni();
      caricaTrasporti();
      caricaStatistiche();
    } else throw new Error();
  })
  .catch(() => document.getElementById('loginErrore').innerText = '‚ùå Credenziali errate');
}

function logout() {
  location.reload();
}

function switchPage(pagina) {
  document.getElementById('paginaRegistro').classList.add('hidden');
  document.getElementById('paginaTrasporti').classList.add('hidden');
  document.getElementById('paginaStatistiche').classList.add('hidden');
  document.getElementById(`pagina${pagina.charAt(0).toUpperCase() + pagina.slice(1)}`)?.classList.remove('hidden');
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  const giorni = ['Domenica','Luned√¨','Marted√¨','Mercoled√¨','Gioved√¨','Venerd√¨','Sabato'];
  const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  return `${giorni[d.getDay()]} ${d.getDate()} ${mesi[d.getMonth()]} ${d.getFullYear()}`;
}

async function caricaPrenotazioni() {
  const res = await fetch('/api/prenotazioni');
  const dati = await res.json();
  const contenitore = document.getElementById('contenitoreGiorni');
  contenitore.innerHTML = '';

  const gruppi = {};
  dati.forEach(p => {
    if (!gruppi[p.data]) gruppi[p.data] = [];
    gruppi[p.data].push(p);
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const wrapper = document.createElement('div');

    const toggle = document.createElement('div');
    toggle.className = 'giorno-blocco';
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => wrapper.querySelector('.prenotazioni-giorno').classList.toggle('hidden');

    const contenuto = document.createElement('div');
    contenuto.className = 'prenotazioni-giorno hidden';

    gruppi[data].forEach(p => {
      const div = document.createElement('div');
      div.className = 'prenotazione';
      div.id = `p-${p.id}`;
      div.innerHTML = `
        <span class="badge" id="badge-${p.id}">üõéÔ∏è</span>
        <div><b>Cliente:</b> ${p.ragioneSociale} (${p.codiceCliente})</div>
        <div><b>CER:</b> ${p.codiceCER}</div>
        <div><b>Quantit√†:</b> ${p.quantita} kg</div>
        <div><b>Stato:</b>
          <select onchange="aggiornaStato(${p.id}, this.value)">
            <option value="in attesa" ${p.stato === 'in attesa' ? 'selected' : ''}>‚è≥ In attesa</option>
            <option value="confermata" ${p.stato === 'confermata' ? 'selected' : ''}>‚úÖ Confermata</option>
            <option value="rifiutata" ${p.stato === 'rifiutata' ? 'selected' : ''}>‚ùå Rifiutata</option>
          </select>
        </div>
        <div class="chat">
          <b>Chat:</b>
          <div class="chat-messaggi" id="chatMsg-${p.id}">Caricamento...</div>
          <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMsg(${p.id})">
          <button class="btn" onclick="inviaMsg(${p.id})">üì® Invia</button>
        </div>`;
      contenuto.appendChild(div);
      caricaChat(p.id);
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    contenitore.appendChild(wrapper);
  });
}

async function aggiornaStato(id, stato) {
  await fetch(`/api/prenotazioni/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ stato })
  });
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chatMsg-${id}`);
  const badge = document.getElementById(`badge-${id}`);
  const suono = document.getElementById('suonoNotifica');

  const key = JSON.stringify(chat);
  if (ultimaChat[id] === key) return;
  ultimaChat[id] = key;

  const ultimo = chat[chat.length - 1];
  if (ultimo && ultimo.autore !== 'admin') {
    badge?.classList.add('show');
    try { suono?.play(); } catch (e) {}
    if (Notification.permission === 'granted' && !document.hasFocus()) {
      new Notification('üì¨ Nuovo messaggio cliente', { body: ultimo.testo });
    }
  } else {
    badge?.classList.remove('show');
  }

  box.innerHTML = chat.map(m => {
    const classe = m.autore === 'admin' ? 'bolla-admin' : 'bolla-user';
    return `<div class="bolla-chat ${classe}">
      <small><b>${m.autore}</b> ‚Äì ${new Date(m.timestamp).toLocaleString()}</small>
      <div>${m.testo}</div>
    </div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

async function inviaMsg(id) {
  const input = document.getElementById(`inputMsg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: 'admin', testo })
  });
  input.value = '';
  caricaChat(id);
}
</script><script>
async function caricaTrasporti() {
  const res = await fetch('/api/trasporti');
  const dati = await res.json();
  const container = document.getElementById('contenitoreTrasporti');
  container.innerHTML = '';

  const gruppi = {};
  dati.forEach(p => {
    if (!gruppi[p.dataTrasporto]) gruppi[p.dataTrasporto] = [];
    gruppi[p.dataTrasporto].push(p);
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const wrapper = document.createElement('div');

    const toggle = document.createElement('div');
    toggle.className = 'giorno-blocco';
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => wrapper.querySelector('.prenotazioni-giorno').classList.toggle('hidden');

    const contenuto = document.createElement('div');
    contenuto.className = 'prenotazioni-giorno hidden';

    gruppi[data].forEach(p => {
      const div = document.createElement('div');
      div.className = 'prenotazione';
      div.id = `t-${p.id}`;
      div.innerHTML = `
        <span class="badge" id="badge-t-${p.id}">üõéÔ∏è</span>
        <div><b>Cliente:</b> ${p.ragioneSociale} (${p.codiceCliente})</div>
        <div><b>Produttore:</b> ${p.produttore}</div>
        <div><b>Tipo:</b> ${p.tipoTrasporto} ‚Äì ${p.tipoMezzo}</div>
        <div><b>Fascia:</b> ${p.fasciaOraria}</div>
        <div><b>Referente:</b> ${p.referente} (${p.cellulare})</div>
        <div><b>Prezzo:</b> ‚Ç¨${p.prezzo}</div>
        <div class="chat">
          <b>Chat:</b>
          <div class="chat-messaggi" id="chatMsgTras-${p.id}">Caricamento...</div>
          <input id="inputMsgTras-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMsgTras(${p.id})">
          <button class="btn" onclick="inviaMsgTras(${p.id})">üì® Invia</button>
        </div>`;
      contenuto.appendChild(div);
      caricaChatTrasporto(p.id);
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    container.appendChild(wrapper);
  });
}

async function caricaChatTrasporto(id) {
  const res = await fetch(`/api/trasporti/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chatMsgTras-${id}`);
  const badge = document.getElementById(`badge-t-${id}`);
  const suono = document.getElementById('suonoNotifica');

  const key = JSON.stringify(chat);
  if (ultimaChat[`t-${id}`] === key) return;
  ultimaChat[`t-${id}`] = key;

  const ultimo = chat[chat.length - 1];
  if (ultimo && ultimo.autore !== 'admin') {
    badge?.classList.add('show');
    try { suono?.play(); } catch (e) {}
    if (Notification.permission === 'granted' && !document.hasFocus()) {
      new Notification('üöõ Nuovo messaggio trasporto', { body: ultimo.testo });
    }
  } else {
    badge?.classList.remove('show');
  }

  box.innerHTML = chat.map(m => {
    const classe = m.autore === 'admin' ? 'bolla-admin' : 'bolla-user';
    return `<div class="bolla-chat ${classe}">
      <small><b>${m.autore}</b> ‚Äì ${new Date(m.timestamp).toLocaleString()}</small>
      <div>${m.testo}</div>
    </div>`;
  }).join('');
  box.scrollTop = box.scrollHeight;
}

async function inviaMsgTras(id) {
  const input = document.getElementById(`inputMsgTras-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  await fetch(`/api/trasporti/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: 'admin', testo })
  });
  input.value = '';
  caricaChatTrasporto(id);
}

// STATISTICHE CER
async function caricaStatistiche() {
  const cer = {};
  let totaleKg = 0;

  const resPren = await fetch("/api/prenotazioni");
  const prenotazioni = await resPren.json();
  prenotazioni.forEach(p => {
    if (!cer[p.codiceCER]) cer[p.codiceCER] = 0;
    cer[p.codiceCER] += Number(p.quantita || 0);
    totaleKg += Number(p.quantita || 0);
  });

  const [utenti, trasporti] = await Promise.all([
    fetch("/utenti.json").then(res => res.json()),
    fetch("/api/trasporti").then(res => res.json())
  ]);

  const box = document.getElementById("statCards");
  box.innerHTML = `
    <div class="card"><h3>üë• ${utenti.length}</h3><p>Clienti</p></div>
    <div class="card"><h3>üì¶ ${prenotazioni.length}</h3><p>Prenotazioni</p></div>
    <div class="card"><h3>‚ôªÔ∏è ${totaleKg}</h3><p>Kg Totali</p></div>
    <div class="card"><h3>üöõ ${trasporti.length}</h3><p>Trasporti</p></div>
  `;

  new Chart(document.getElementById("graficoCER").getContext("2d"), {
    type: "pie",
    data: {
      labels: Object.keys(cer),
      datasets: [{
        data: Object.values(cer),
        backgroundColor: ['#00785c', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#28a745']
      }]
    }
  });
}

// AUTO REFRESH chat ogni 3s
setInterval(() => {
  if (!adminAutenticato) return;
  document.querySelectorAll('[id^="chatMsg-"]').forEach(div => {
    const id = div.id.split('-')[1];
    caricaChat(id);
  });
  document.querySelectorAll('[id^="chatMsgTras-"]').forEach(div => {
    const id = div.id.split('-')[1];
    caricaChatTrasporto(id);
  });
}, 3000);

// Caricamento tema dark all'avvio
window.onload = () => {
  if (localStorage.getItem("darkMode") === "true") {
    document.body.classList.add("dark");
  }
};
</script>
</body>
</html>


