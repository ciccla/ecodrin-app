<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin ‚Äì Eco.Drin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #333;
    }

    header {
      background-color: #004c45;
      color: white;
      padding: 20px;
      display: flex;
      align-items: center;
      gap: 15px;
    }

    header img {
      height: 50px;
    }

    main {
      max-width: 1100px;
      margin: 30px auto;
      padding: 30px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    h2 {
      color: #004c45;
      margin-top: 0;
    }

    .hidden {
      display: none !important;
    }

    .btn-green {
      background: #28a745;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 5px;
    }

    .btn-green:hover {
      background: #218838;
    }

    .giorno-blocco {
      background: #eafaf5;
      padding: 10px 15px;
      border-radius: 8px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: bold;
      border: 1px solid #b3e5c5;
    }

    .prenotazione {
      background: #f8f9fa;
      border: 1px solid #ccc;
      padding: 15px;
      margin-top: 10px;
      border-radius: 6px;
    }

    select, input {
      padding: 6px;
      margin-top: 5px;
      width: 100%;
      max-width: 300px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .chat-messaggi {
      background: #e9fdf4;
      padding: 12px;
      border: 1px solid #b0eacd;
      border-radius: 8px;
      box-shadow: inset 0 0 6px rgba(0, 120, 92, 0.15);
      max-height: 180px;
      overflow-y: auto;
      margin: 10px 0;
    }

    .msg {
      background: #c8f7e3;
      border: 1px solid #a2e7cd;
      padding: 10px 14px;
      border-radius: 8px;
      margin-bottom: 8px;
      font-size: 14px;
      box-shadow: 0 2px 4px rgba(0, 120, 92, 0.08);
    }

    .msg small {
      display: block;
      font-size: 11px;
      color: #555;
      margin-top: 6px;
    }

    .card {
      background: #eafaf5;
      padding: 20px;
      border-radius: 10px;
      display: inline-block;
      margin: 10px;
      text-align: center;
    }

    .chat-notifica {
      display: inline-block;
      background: #dc3545;
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 8px;
      vertical-align: middle;
    }

    .hidden {
      display: none !important;
    }

    footer {
      text-align: center;
      font-size: 14px;
      color: #777;
      margin-top: 50px;
    }
  </style>
</head>
<body>
<header>
  <img src="eco.drin-_srl.png" alt="Logo" />
  <h1>Area Amministratore</h1>
</header>

<main>
  <div id="loginBox">
    <h2>üîê Login Admin</h2>
    <input id="loginEmail" placeholder="Email"
      onkeydown="if(event.key==='Enter') login()" />
    <input id="loginPassword" type="password" placeholder="Password"
      onkeydown="if(event.key==='Enter') login()" />
    <button class="btn-green" onclick="login()">Accedi</button>
    <div id="loginErrore" style="color:red; margin-top:10px;"></div>
  </div>

  <div id="contenutoAdmin" class="hidden">
    <div id="menuAdmin" style="margin-bottom:20px;">
      <button class="btn-green" onclick="switchPage('registro')">üì¶ Prenotazioni</button>
      <button class="btn-green" onclick="switchPage('statistiche')">üìä Statistiche</button>
      <button class="btn-green" onclick="logout()">üö™ Logout</button>
    </div>

    <section id="paginaRegistro">
      <h2>üìÅ Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </section>

    <section id="paginaStatistiche" class="hidden">
      <h2>üìä Statistiche</h2>
      <div id="statCards"></div>
      <canvas id="graficoCER" style="max-width:600px; margin-top:30px;"></canvas>
      <ul id="statistiche"></ul>
    </section>
  </div>
</main>

<footer>
  üìç Via delle Industrie ‚Äì Zona Asi - 80011 Acerra (NA) |
  üìû 081.8857480 / 081.5207650 |
  ‚úâÔ∏è info@ecodrinsrl.it / impianto@ecodrinsrl.it
  <br>¬©2025 Eco.Drin s.r.l. ‚Äì P.I: 03378791218
</footer>



  <!-- parte 2-->

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let chatTimers = {};
let chatLastMessage = {};

function switchPage(pagina) {
  ["paginaRegistro", "paginaTrasporti", "paginaStatistiche"].forEach(id =>
    document.getElementById(id).classList.add("hidden")
  );
  document.getElementById("pagina" + capitalize(pagina)).classList.remove("hidden");
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.ok ? res.json() : Promise.reject())
  .then(json => {
    if (json.tipo === 'admin') {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("contenutoAdmin").classList.remove("hidden");
      document.getElementById("menuAdmin").classList.remove("hidden");
      document.getElementById("logoutBtn").classList.remove("hidden");
      caricaPrenotazioni();
      caricaTrasporti();
      caricaStatistiche();
    } else throw new Error();
  })
  .catch(() => document.getElementById("loginErrore").innerText = "‚ùå Credenziali errate");
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

function aggiornaStato(id, stato, tipo = "prenotazioni") {
  fetch(`/api/${tipo}/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stato })
  });
}

async function caricaPrenotazioni() {
  const res = await fetch("/api/prenotazioni");
  const dati = await res.json();
  const contenitore = document.getElementById("contenitoreGiorni");
  contenitore.innerHTML = "";

  const gruppi = {};
  dati.forEach(p => {
    if (!gruppi[p.data]) gruppi[p.data] = [];
    gruppi[p.data].push(p);
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const wrapper = document.createElement("div");
    const toggle = document.createElement("div");
    toggle.className = "giorno-blocco";
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;
    toggle.onclick = () => {
      const box = wrapper.querySelector(".prenotazioni-giorno");
      box.classList.toggle("hidden");
    };

    const contenuto = document.createElement("div");
    contenuto.className = "prenotazioni-giorno hidden";

    gruppi[data].forEach(p => {
      const div = document.createElement("div");
      div.className = "prenotazione";
      div.innerHTML = `
        <b>Cliente:</b> ${p.ragioneSociale}<br>
        <b>Produttore:</b> ${p.produttore}<br>
        <b>CER:</b> ${p.codiceCER} | <b>Quantit√†:</b> ${p.quantita} kg<br>
        <b>Imballo:</b> ${p.tipoImballo} | <b>Stato Fisico:</b> ${p.statoFisico}<br>
        <b>Pericolosit√†:</b> ${p.pericolosita || "N/D"}<br>
        <b>Stato:</b> 
        <select onchange="aggiornaStato(${p.id}, this.value)">
          <option ${p.stato === "in attesa" ? "selected" : ""}>‚è≥ in attesa</option>
          <option ${p.stato === "confermata" ? "selected" : ""}>‚úÖ confermata</option>
          <option ${p.stato === "rifiutata" ? "selected" : ""}>‚ùå rifiutata</option>
        </select>
        <div class="chat-messaggi" id="chat-${p.id}">Caricamento chat...</div>
        <input id="input-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMessaggio(${p.id})" />
        <button onclick="inviaMessaggio(${p.id})">üì® Invia</button>
      `;
      contenuto.appendChild(div);
      caricaChat(p.id);
    });

    wrapper.appendChild(toggle);
    wrapper.appendChild(contenuto);
    contenitore.appendChild(wrapper);
  });
}

async function caricaTrasporti() {
  const res = await fetch("/api/trasporti");
  const dati = await res.json();
  const contenitore = document.getElementById("contenitoreTrasportiAdmin");
  contenitore.innerHTML = "";

  const gruppi = {};
  dati.forEach(p => {
    if (!gruppi[p.dataTrasporto]) gruppi[p.dataTrasporto] = [];
    gruppi[p.dataTrasporto].push(p);
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const toggle = document.createElement("div");
    toggle.className = "giorno-blocco";
    toggle.textContent = `üìÖ ${formattaData(data)} (${gruppi[data].length})`;

    const contenuto = document.createElement("div");
    contenuto.className = "prenotazioni-giorno";

    gruppi[data].forEach(p => {
      const div = document.createElement("div");
      div.className = "prenotazione";
      div.innerHTML = `
        <b>Richiedente:</b> ${p.richiedente} | <b>Produttore:</b> ${p.produttore}<br>
        <b>Tipo Trasporto:</b> ${p.tipoTrasporto} | <b>Automezzo:</b> ${p.automezzo}<br>
        <b>Fascia Oraria:</b> ${p.fasciaOraria}<br>
        <b>Referente:</b> ${p.referente} - ${p.cellulare}<br>
        <b>Prezzo:</b> ‚Ç¨${p.prezzo}<br>
        <b>Stato:</b> 
        <select onchange="aggiornaStato(${p.id}, this.value, 'trasporti')">
          <option ${p.stato === "in attesa" ? "selected" : ""}>‚è≥ in attesa</option>
          <option ${p.stato === "confermata" ? "selected" : ""}>‚úÖ confermata</option>
          <option ${p.stato === "rifiutata" ? "selected" : ""}>‚ùå rifiutata</option>
        </select>
        <div class="chat-messaggi" id="chat-trasporto-${p.id}">Chat...</div>
        <input id="input-trasporto-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') inviaMessaggio(${p.id}, 'trasporti')" />
        <button onclick="inviaMessaggio(${p.id}, 'trasporti')">üì® Invia</button>
      `;
      contenuto.appendChild(div);
      caricaChat(p.id, 'trasporti');
    });

    contenitore.appendChild(toggle);
    contenitore.appendChild(contenuto);
  });
}

async function caricaChat(id, tipo = 'prenotazioni') {
  const res = await fetch(`/api/${tipo}/${id}/chat`);
  const chat = await res.json();
  const box = document.getElementById(`chat${tipo === 'trasporti' ? '-trasporto' : ''}-${id}`);
  if (!box) return;

  const lastMsg = chat[chat.length - 1];
  const lastKnown = chatLastMessage[id]?.timestamp;

  if (
    lastMsg &&
    (!lastKnown || lastMsg.timestamp > lastKnown) &&
    lastMsg.autore !== "impianto"
  ) {
    try { new Audio("/sounds/notify.mp3").play(); } catch {}
  }

  chatLastMessage[id] = lastMsg;

  box.innerHTML = chat.map(m => `
    <div class="msg">
      <b>${m.autore}</b>: ${m.testo}
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>
  `).join('');
  box.scrollTop = box.scrollHeight;

  if (!chatTimers[id]) {
    chatTimers[id] = setInterval(() => caricaChat(id, tipo), 2000);
  }
}

async function inviaMessaggio(id, tipo = "prenotazioni") {
  const inputId = tipo === "trasporti" ? `input-trasporto-${id}` : `input-${id}`;
  const input = document.getElementById(inputId);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`/api/${tipo}/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: "impianto", testo })
  });

  input.value = "";
  caricaChat(id, tipo);
}

async function caricaStatistiche() {
  const prenRes = await fetch("/api/prenotazioni");
  const trasRes = await fetch("/api/trasporti");
  const pren = await prenRes.json();
  const tras = await trasRes.json();

  const clientiUnici = [...new Set(pren.map(p => p.ragioneSociale))].length;
  const totaleKg = pren.reduce((sum, p) => sum + Number(p.quantita || 0), 0);
  const cer = {};
  pren.forEach(p => {
    cer[p.codiceCER] = (cer[p.codiceCER] || 0) + Number(p.quantita || 0);
  });

  const cardContainer = document.getElementById('statCards');
  cardContainer.innerHTML = `
    <div class="card"><h3>üßë‚Äçüíº ${clientiUnici}</h3><p>Clienti</p></div>
    <div class="card"><h3>üì¶ ${pren.length}</h3><p>Prenotazioni</p></div>
    <div class="card"><h3>üöõ ${tras.length}</h3><p>Trasporti</p></div>
    <div class="card"><h3>‚öñÔ∏è ${totaleKg}</h3><p>Totale kg</p></div>
  `;

  new Chart(document.getElementById("graficoCER"), {
    type: "pie",
    data: {
      labels: Object.keys(cer),
      datasets: [{
        data: Object.values(cer),
        backgroundColor: ['#00785c', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#28a745', '#20c997']
      }]
    }
  });
}
</script>
</body>
</html>

 
