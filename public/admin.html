<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Admin ‚Äì Ecodrin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 0; background: #f4f6f8; }
    header {
      background: #007acc; color: white; padding: 15px 30px;
      display: flex; justify-content: space-between; align-items: center;
    }
    main {
      max-width: 1100px; margin: 30px auto;
      background: white; padding: 30px;
      border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    .giorno {
      margin-top: 20px; border: 1px solid #ddd;
      border-radius: 6px; background: #f9f9f9;
    }
    .giorno h3 {
      margin: 0; padding: 15px; background: #007acc;
      color: white; cursor: pointer; font-size: 18px;
      border-radius: 6px 6px 0 0; user-select: none;
    }
    .contenuto { padding: 15px; display: none; }
    .prenotazione {
      border-bottom: 1px solid #eee;
      padding: 12px 0; position: relative;
    }
    .badge {
      position: absolute; top: 10px; right: 10px;
      background: red; color: white; font-size: 12px;
      padding: 4px 6px; border-radius: 10px; display: none;
    }
    .chat {
      background: #eef2f5; padding: 10px;
      border-radius: 6px; margin-top: 10px;
    }
    .chat-messaggi {
      max-height: 200px; overflow-y: auto;
      background: white; padding: 10px;
      border: 1px solid #ccc; border-radius: 4px;
    }
    .messaggio {
      margin-bottom: 8px; padding: 6px 10px;
      background: white; border-left: 4px solid #007acc;
      border-radius: 4px;
    }
    .messaggio small {
      display: block; font-size: 11px; color: #555;
    }
    .chat input {
      width: 80%; padding: 8px;
      border-radius: 4px; border: 1px solid #ccc;
      margin-right: 5px;
    }
    .chat button {
      padding: 8px 12px; background-color: #28a745;
      color: white; border: none; border-radius: 4px;
    }
    button {
      margin: 5px 5px 0 0; padding: 5px 12px;
      border: none; background: #007acc;
      color: white; border-radius: 4px; cursor: pointer;
    }
    button.rifiuta { background: #d9534f; }
    .stato { font-weight: bold; }
    canvas { max-width: 500px; margin-top: 30px; }
    .top-bar {
      display: flex; justify-content: space-between;
      align-items: center;
    }
  </style>
</head>
<body>

<header class="hidden" id="adminHeader">
  <h1>üìä Pannello Admin ‚Äì Ecodrin</h1>
  <div>
    <select onchange="switchPage(this.value)">
      <option value="registro">üìã Registro</option>
      <option value="statistiche">üìà Statistiche</option>
    </select>
    <button onclick="logout()">üö™ Logout</button>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <div id="loginBox">
    <h2>üîê Login Admin</h2>
    <input id="loginEmail" placeholder="Email" onkeydown="if(event.key==='Enter') login()">
    <input id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">Accedi</button>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <!-- CONTENUTO ADMIN -->
  <div id="contenutoAdmin" class="hidden">
    <div id="paginaRegistro">
      <h2>üìã Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </div>

    <div id="paginaStatistiche" class="hidden">
      <div class="top-bar">
        <h2>üìà Statistiche CER</h2>
        <button type="button" onclick="esportaCSV()">üì§ Esporta CSV</button>
      </div>
      <ul id="statistiche"></ul>
      <canvas id="graficoCER"></canvas>
    </div>
  </div>
</main>




  <!-- parte 2-->

  <script>
let prenotazioni = [];

function login() {
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  fetch("/api/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.json())
  .then(json => {
    if (json.tipo === "admin") {
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("contenutoAdmin").classList.remove("hidden");
      document.getElementById("adminHeader").classList.remove("hidden");
      caricaPrenotazioni();
      mostraPagina("registro");
    } else {
      document.getElementById("loginErrore").innerText = "‚ùå Credenziali errate";
    }
  });
}

function logout() {
  location.reload();
}

function switchPage(val) {
  mostraPagina(val);
}

function mostraPagina(nome) {
  document.getElementById("paginaRegistro").classList.add("hidden");
  document.getElementById("paginaStatistiche").classList.add("hidden");
  document.getElementById("pagina" + capitalize(nome)).classList.remove("hidden");
  if (nome === "statistiche") caricaStatistiche();
}

function capitalize(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

function caricaPrenotazioni() {
  fetch("/api/prenotazioni")
    .then(res => res.json())
    .then(dati => {
      prenotazioni = dati;
      const contenitore = document.getElementById("contenitoreGiorni");
      contenitore.innerHTML = "";
      const gruppi = {};
      dati.forEach(p => {
        if (!gruppi[p.data]) gruppi[p.data] = [];
        gruppi[p.data].push(p);
      });

      Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
        const giorno = document.createElement("div");
        giorno.className = "giorno";
        giorno.innerHTML = `<h3 onclick="toggleGiorno(this)">${formattaData(data)} (${gruppi[data].length})</h3>`;
        const contenuto = document.createElement("div");
        contenuto.className = "contenuto";
        gruppi[data].forEach(p => {
          const div = document.createElement("div");
          div.className = "prenotazione";
          div.innerHTML = `
            <b>Cliente:</b> ${p.ragioneSociale}<br>
            <b>Produttore:</b> ${p.produttore}<br>
            <b>CER:</b> ${p.codiceCER} | <b>Quantit√†:</b> ${p.quantita} kg<br>
            <b>Imballo:</b> ${p.tipoImballo} | <b>Stato:</b> ${p.statoFisico}<br>
            <b>Pericolosit√†:</b> ${p.pericolosita || "N/D"}<br>
            <b>Stato:</b> 
            <select onchange="aggiornaStato(${p.id}, this.value)">
              <option ${p.stato === "in attesa" ? "selected" : ""}>in attesa</option>
              <option ${p.stato === "confermata" ? "selected" : ""}>confermata</option>
              <option ${p.stato === "rifiutata" ? "selected" : ""}>rifiutata</option>
            </select>
            ${p.analisi ? `<div><b>Analisi:</b> <a href="/uploads/${p.analisi}" target="_blank">üìÑ PDF</a></div>` : ""}
            <div class="chat">
              <div class="chat-messaggi" id="chat-${p.id}">Caricamento...</div>
              <input id="input-${p.id}" placeholder="Scrivi un messaggio..." onkeydown="if(event.key==='Enter') invia(${p.id})">
              <button onclick="invia(${p.id})">üì®</button>
            </div>`;
          contenuto.appendChild(div);
          caricaChat(p.id);
        });
        giorno.appendChild(contenuto);
        contenitore.appendChild(giorno);
      });
    });
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth()+1).toString().padStart(2, '0')}/${d.getFullYear()}`;
}

function toggleGiorno(el) {
  const box = el.nextElementSibling;
  box.style.display = box.style.display === "none" || !box.style.display ? "block" : "none";
}

function aggiornaStato(id, stato) {
  fetch(`/api/prenotazioni/${id}`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ stato })
  });
}

function caricaChat(id) {
  fetch(`/api/prenotazioni/${id}/chat`)
    .then(res => res.json())
    .then(chat => {
      const box = document.getElementById(`chat-${id}`);
      if (!box) return;
      box.innerHTML = chat.map(m => `
        <div class="messaggio">
          <small><b>${m.autore}</b> ‚Äì ${new Date(m.timestamp).toLocaleString()}</small>
          ${m.testo}
        </div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    });
}

function invia(id) {
  const input = document.getElementById(`input-${id}`);
  const testo = input.value.trim();
  if (!testo) return;
  fetch(`/api/prenotazioni/${id}/chat`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ autore: "impianto", testo })
  }).then(() => {
    input.value = "";
    caricaChat(id);
  });
}

function caricaStatistiche() {
  const cer = {};
  prenotazioni.forEach(p => {
    if (!cer[p.codiceCER]) cer[p.codiceCER] = 0;
    cer[p.codiceCER] += Number(p.quantita || 0);
  });

  const ctx = document.getElementById("graficoCER").getContext("2d");
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: Object.keys(cer),
      datasets: [{
        data: Object.values(cer),
        backgroundColor: ['#00785c', '#ffc107', '#dc3545', '#6f42c1', '#17a2b8', '#28a745', '#20c997']
      }]
    }
  });
}

function esportaCSV() {
  const righe = [
    ["Cliente", "Produttore", "CER", "Quantit√†", "Data", "Stato"]
  ];
  prenotazioni.forEach(p => {
    righe.push([p.ragioneSociale, p.produttore, p.codiceCER, p.quantita, p.data, p.stato]);
  });
  const csv = righe.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const link = document.createElement("a");
  link.href = url;
  link.download = "prenotazioni.csv";
  link.click();
}
</script>
</body>
</html>

