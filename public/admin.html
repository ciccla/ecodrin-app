<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Ecodrin</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      background: #f4f6f8;
      color: #111;
      transition: background 0.3s;
    }
    body.dark {
      background: #121212;
      color: #f0f0f0;
    }
    header {
      background: #007acc;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    main {
      max-width: 1100px;
      margin: 30px auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    body.dark main {
      background: #1e1e1e;
    }
    .hidden { display: none; }
    .giorno h3 {
      background: #007acc;
      color: white;
      padding: 10px;
      cursor: pointer;
      margin: 0;
      border-radius: 6px;
    }
    .contenuto { padding: 10px; display: none; }
    .prenotazione {
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
    }
    body.dark .prenotazione {
      background: #2a2a2a;
    }
    .chat {
      margin-top: 10px;
    }
    .chat-messaggi {
      max-height: 150px;
      overflow-y: auto;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    body.dark .chat-messaggi {
      background: #333;
      border-color: #555;
    }
    .messaggio {
      margin-bottom: 6px;
      background: #e0f0ff;
      padding: 6px;
      border-radius: 5px;
    }
    body.dark .messaggio {
      background: #444;
    }
    .badge {
      background: red;
      color: white;
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 12px;
      display: none;
    }
    .badge.show { display: inline-block; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .dark-toggle {
      background: #fff;
      border: none;
      border-radius: 4px;
      padding: 6px 10px;
      cursor: pointer;
      color: #333;
    }
    .stat-box {
      background: #007acc;
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
      flex: 1;
      min-width: 200px;
      margin: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .stat-box h2 {
      margin: 0;
      font-size: 32px;
    }
    .stat-box p {
      margin-top: 6px;
      font-size: 15px;
    }
  </style>
</head>
<body>

<header class="hidden" id="adminHeader">
  <h1>ğŸ“Š Pannello Admin â€“ Ecodrin</h1>
  <div>
    <select onchange="switchPage(this.value)">
      <option value="registro">ğŸ“‹ Registro</option>
      <option value="trasporti">ğŸš› Trasporti</option>
      <option value="statistiche">ğŸ“ˆ Statistiche</option>
    </select>
    <button class="dark-toggle" onclick="toggleDark()">ğŸŒ“</button>
    <button onclick="logout()">ğŸšª Logout</button>
  </div>
</header>

<main>
  <div id="loginBox">
    <h2>ğŸ” Login Admin</h2>
    <input id="loginEmail" placeholder="Email" onkeydown="if(event.key==='Enter') login()">
    <input id="loginPassword" type="password" placeholder="Password" onkeydown="if(event.key==='Enter') login()">
    <button onclick="login()">Accedi</button>
    <div id="loginErrore" style="color:red;"></div>
  </div>

  <div id="contenutoAdmin" class="hidden">
    <!-- Registro Prenotazioni -->
    <div id="paginaRegistro">
      <h2>ğŸ“‹ Registro Prenotazioni</h2>
      <div id="contenitoreGiorni"></div>
    </div>

    <!-- Registro Trasporti -->
    <div id="paginaTrasporti" class="hidden">
      <h2>ğŸš› Registro Trasporti</h2>
      <div id="contenitoreTrasporti"></div>
    </div>

    <!-- Statistiche + KPI -->
    <div id="paginaStatistiche" class="hidden">
      <div class="top-bar">
        <h2>ğŸ“ˆ Statistiche CER</h2>
        <button onclick="esportaCSV()">ğŸ“¤ Esporta CSV</button>
      </div>
      <div id="kpiStats" style="display: flex; flex-wrap: wrap; justify-content: space-between; gap: 10px; margin-bottom: 30px;"></div>
      <canvas id="graficoCER"></canvas>
    </div>
  </div>

  <audio id="suonoNotifica" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_9ce296083a.mp3" preload="auto"></audio>
<script>
let adminAutenticato = false;

function login() {
  const email = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value.trim();

  fetch('/api/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ragioneSociale: email, password })
  })
  .then(res => res.json())
  .then(json => {
    if (json.tipo === 'admin') {
      adminAutenticato = true;
      document.getElementById('loginBox').classList.add('hidden');
      document.getElementById('contenutoAdmin').classList.remove('hidden');
      document.getElementById('adminHeader').classList.remove('hidden');
      caricaPrenotazioni();
      caricaStatistiche();
    } else {
      throw new Error();
    }
  })
  .catch(() => {
    document.getElementById('loginErrore').innerText = 'âŒ Credenziali errate';
  });
}

function logout() {
  adminAutenticato = false;
  location.reload();
}

function switchPage(p) {
  document.getElementById('paginaRegistro').classList.add('hidden');
  document.getElementById('paginaStatistiche').classList.add('hidden');
  document.getElementById('paginaTrasporti')?.classList.add('hidden');
  document.getElementById(`pagina${p.charAt(0).toUpperCase() + p.slice(1)}`)?.classList.remove('hidden');
}

function toggleGiorno(el) {
  const contenuto = el.nextElementSibling;
  contenuto.style.display = contenuto.style.display === 'block' ? 'none' : 'block';
}

function formattaData(dataStr) {
  const d = new Date(dataStr);
  const giorni = ['Domenica','LunedÃ¬','MartedÃ¬','MercoledÃ¬','GiovedÃ¬','VenerdÃ¬','Sabato'];
  const mesi = ['Gennaio','Febbraio','Marzo','Aprile','Maggio','Giugno','Luglio','Agosto','Settembre','Ottobre','Novembre','Dicembre'];
  return `${giorni[d.getDay()]} ${d.getDate()} ${mesi[d.getMonth()]} ${d.getFullYear()}`;
}

async function caricaPrenotazioni() {
  const res = await fetch('/api/prenotazioni');
  const dati = await res.json();
  const contenitore = document.getElementById('contenitoreGiorni');
  contenitore.innerHTML = '';

  const gruppi = {};
  dati.forEach(p => {
    if (p.data) {
      if (!gruppi[p.data]) gruppi[p.data] = [];
      gruppi[p.data].push(p);
    }
  });

  Object.keys(gruppi).sort((a,b)=>new Date(b)-new Date(a)).forEach(data => {
    const giorno = document.createElement('div');
    giorno.className = 'giorno';
    giorno.innerHTML = `<h3 onclick="toggleGiorno(this)">${formattaData(data)} (${gruppi[data].length})</h3>`;
    const contenuto = document.createElement('div');
    contenuto.className = 'contenuto';

    gruppi[data].forEach(p => {
      const div = document.createElement('div');
      div.className = 'prenotazione';
      div.innerHTML = `
        <span class="badge" id="badge-${p.id}">ğŸ›ï¸</span>
        <div><b>Cliente:</b> ${p.ragioneSociale} (${p.codiceCliente})</div>
        <div><b>CER:</b> ${p.codiceCER}</div>
        <div><b>QuantitÃ :</b> ${p.quantita} kg</div>
        <div><b>Stato:</b> <span id="stato-${p.id}" class="stato">${p.stato}</span></div>
        <div>
          <button type="button" onclick="aggiornaStato(${p.id}, 'confermata')">âœ… Conferma</button>
          <button type="button" onclick="aggiornaStato(${p.id}, 'rifiutata')" class="rifiuta">âŒ Rifiuta</button>
        </div>
        <div class="chat">
          <b>Chat:</b>
          <div class="chat-messaggi" id="chatMsg-${p.id}">Caricamento...</div>
          <div style="margin-top:10px;">
            <input id="inputMsg-${p.id}" placeholder="Scrivi un messaggio." onkeydown="if(event.key==='Enter') inviaMessaggio(${p.id})">
            <button onclick="inviaMessaggio(${p.id})">ğŸ“¨</button>
          </div>
        </div>`;
      contenuto.appendChild(div);
      caricaChat(p.id);
    });

    giorno.appendChild(contenuto);
    contenitore.appendChild(giorno);
  });
}

async function caricaChat(id) {
  const res = await fetch(`/api/prenotazioni/${id}/chat`);
  const chat = await res.json();
  const div = document.getElementById(`chatMsg-${id}`);
  const badge = document.getElementById(`badge-${id}`);
  const suono = document.getElementById('suonoNotifica');

  const last = chat[chat.length - 1];
  if (last && last.autore !== 'admin') {
    badge?.classList.add('show');
    suono?.play();
  } else {
    badge?.classList.remove('show');
  }

  div.innerHTML = chat.map(m => `
    <div class="messaggio">
      <b>${m.autore}</b>: ${m.testo}<br>
      <small>${new Date(m.timestamp).toLocaleString()}</small>
    </div>`).join('');
  div.scrollTop = div.scrollHeight;
}

async function inviaMessaggio(id) {
  const input = document.getElementById(`inputMsg-${id}`);
  const testo = input.value.trim();
  if (!testo) return;

  await fetch(`/api/prenotazioni/${id}/chat`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ autore: 'impianto', testo })
  });

  input.value = '';
  caricaChat(id);
}

async function aggiornaStato(id, stato) {
  await fetch(`/api/prenotazioni/${id}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ stato })
  });
  document.getElementById(`stato-${id}`).textContent = stato;
}

async function caricaStatistiche() {
  const cer = {};
  let totaleKg = 0;

  const resPren = await fetch("/api/prenotazioni");
  const prenotazioni = await resPren.json();
  prenotazioni.forEach(p => {
    if (!cer[p.codiceCER]) cer[p.codiceCER] = 0;
    cer[p.codiceCER] += Number(p.quantita || 0);
    totaleKg += Number(p.quantita || 0);
  });

  const [utenti, trasporti] = await Promise.all([
    fetch("/utenti.json").then(res => res.json()),
    fetch("/api/trasporti").then(res => res.json())
  ]);

  const box = document.getElementById("kpiStats");
  box.innerHTML = `
    <div class="stat-box"><h2>${utenti.length}</h2><p>ğŸ‘¥ Clienti</p></div>
    <div class="stat-box"><h2>${prenotazioni.length}</h2><p>ğŸ“¦ Prenotazioni</p></div>
    <div class="stat-box"><h2>${totaleKg}</h2><p>â™»ï¸ Kg Totali</p></div>
    <div class="stat-box"><h2>${trasporti.length}</h2><p>ğŸš› Trasporti</p></div>
  `;

  new Chart(document.getElementById("graficoCER").getContext("2d"), {
    type: "pie",
    data: {
      labels: Object.keys(cer),
      datasets: [{
        data: Object.values(cer),
        backgroundColor: ['#007acc', '#ffc107', '#28a745', '#dc3545', '#6f42c1']
      }]
    }
  });
}

function esportaCSV() {
  window.open('/api/prenotazioni/export', '_blank');
}

function toggleDark() {
  document.body.classList.toggle('dark');
}

setInterval(() => {
  if (!adminAutenticato) return;
  document.querySelectorAll('.chat-messaggi').forEach(div => {
    const id = div.id.split('-')[1];
    caricaChat(id);
  });
}, 3000);
</script>
</body>
</html>
